<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©quisition de Mat√©riel - SAD-PA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- STYLES G√âN√âRAUX ET POUR L'√âCRAN --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px; 
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #435ebe 0%, #667eea 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .form-section {
            padding: 25px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
            margin: 0 25px 20px 25px;
            background: transparent;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }
        /* Indication d'erreur pour les champs requis */
        .form-group input.input-error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25);
        }
        /* Message d'erreur discret pour le formulaire */
        .form-error {
            display: none;
            color: #dc3545;
            background: #fff5f5;
            border-left: 3px solid #dc3545;
            padding: 8px 10px;
            border-radius: 6px;
            margin: 0 0 10px 0;
            font-size: 13px;
        }
        
        .inventory-section {
            padding: 25px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
            margin: 0 25px 20px 25px;
            background: transparent;
        }

        #inventoryContainer {
            display: block;
        }

        .category {
            margin-bottom: 20px;
        }
        
        .category h3 {
            font-weight: 700;
            padding: 10px 15px;
            margin: 0 0 12px 0;
            color: #435ebe;
            border-left: 4px solid #667eea;
            background-color: #f8f9fa;
            font-size: 15px;
            border-radius: 4px;
        }
        
        .items-grid {
            display: grid;
            gap: 0;
        }
        
        .item {
            display: grid;
            grid-template-columns: 25px 45px 1fr 80px 70px;
            align-items: center;
            gap: 12px;
            padding: 10px 8px;
            background: transparent;
            border-radius: 0;
            transition: background-color 0.3s;
            border: none;
            border-bottom: 1px dotted #e0e0e0;
        }

        .item.selected {
            background: rgba(102, 126, 234, 0.05);
            border-bottom-color: #b8c1f3;
        }
        
        .item:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        
        .item.focused {
            outline: 2px solid #667eea;
            outline-offset: -1px;
            background: rgba(102, 126, 234, 0.08);
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        /* Masquer l'indicateur de focus en impression */
        @media print {
            .item.focused {
                outline: none !important;
                box-shadow: none !important;
                background: transparent !important;
                z-index: auto !important;
            }
        }

        .item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .item-details { 
            display: flex; 
            flex-direction: column; 
            gap: 5px;
            min-width: 0; /* Permet au texte de se tronquer si n√©cessaire */
        }
        .item-name { 
            font-weight: 500;
            font-size: 14px;
        }
        .special-inputs { display: flex; gap: 5px; }
        .special-input {
            width: 80px; font-size: 12px; padding: 3px;
            border: 1px solid #ccc; border-radius: 3px;
        }
        .special-input:disabled { background: #f0f0f0; }
        
        .item-max {
            color: #6c757d;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2px 8px;
            white-space: nowrap;
            border: 1px solid #e0e0e0;
        }
        
        .item-price { 
            color: #28a745; 
            font-weight: 600; 
            font-size: 14px;
            text-align: right;
            justify-self: end;
            white-space: nowrap;
            padding-right: 8px;
            min-width: 60px;
        }
        
        .qty-controls { 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
        }
        
        /* Masquer les boutons sur desktop, garder le champ */
        .qty-btn {
            display: none;
        }
        
        /* Boutons cach√©s mais gardant leur espace pour l'alignement */
        .qty-btn[style*="visibility: hidden"] {
            visibility: hidden !important;
        }
        /* Style de base des boutons - masqu√©s sur desktop */
        .qty-btn {
            width: 28px; 
            height: 22px; 
            border: 1px solid #ddd; 
            background: #fff;
            border-radius: 4px; 
            font-size: 10px; 
            cursor: pointer; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            color: #666; 
            font-weight: bold;
            flex-shrink: 0;
        }
        .qty-btn:hover { background: #f0f0f0; border-color: #999; }
        .qty-btn.decrement { color: #dc3545; }
        .qty-btn.increment { color: #28a745; }
        .qty-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #f8f8f8; }
        
        .item-qty {
            width: 40px; 
            padding: 3px 2px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            text-align: center; 
            font-size: 13px; 
            font-weight: bold;
            flex-shrink: 0;
        }
        .item-qty:disabled { background: #f5f5f5; color: #999; }
        
        .controls {
            background: #f8f9fa;
            padding: 20px 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid #e9ecef;
        }
        
        .btn {
            padding: 12px 28px; border: none; border-radius: 8px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
            text-decoration: none; display: inline-block; text-align: center;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary { background: #28a745; color: white; }
        .btn-primary:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #007bff; color: white; }
        .btn-success:hover { background: #0069d9; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-outlook { background: #0078d4; color: white; }
        .btn-outlook:hover { background: #106ebe; }
        .btn-outline { background: transparent; color: #667eea; border: 2px solid #667eea; }
        .btn-outline:hover { background: #667eea; color: white; }
        
        /* Styles pour la modal d'historique */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .modal-header {
            padding: 20px 25px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-footer {
            padding: 15px 25px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Styles pour l'historique */
        .history-stats {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .history-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }
        .history-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102,126,234,0.1);
        }
        .history-item.pinned {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .history-client {
            font-weight: 600;
            color: #333;
        }
        .history-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .pin-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .pin-button:hover {
            background: #f0f0f0;
        }
        .pin-button.pinned {
            color: #28a745;
        }
        .restore-button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .restore-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .history-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }
        .history-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .history-status.imprim√©e {
            background: #e3f2fd;
            color: #1565c0;
        }
        .history-status.envoy√©e {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .summary {
            margin: 0 25px 20px 25px;
            padding: 20px;
            background: #f9f9f9;
            border: none;
            border-top: 1px solid #e0e0e0;
            border-radius: 0;
            display: none;
        }
        .summary h4 { 
            color: #155724; 
            margin-bottom: 15px; 
            font-size: 16px; 
            font-weight: 700;
            text-align: center;
        }
        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .summary-content > div:not(:last-child):not(.summary-total) {
            border-right: 1px dotted #ccc;
            padding-right: 15px;
        }
        .summary-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 4px; 
            font-size: 12px;
            padding: 2px 0;
        }
        .summary-total { 
            font-weight: bold; 
            font-size: 14px; 
            color: #155724; 
            border-top: 2px solid #c3e6c3; 
            padding-top: 8px; 
            margin-top: 8px;
            text-align: center;
            grid-column: 1 / -1;
        }
        
        .print-only { display: none; }
        .print-special-value { display: none; }

        /* Bouton historique pr√®s de la recherche */
        .btn-history-search {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .btn-history-search:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Styles pour la recherche */
        .search-container {
            position: relative;
            margin: 0 auto 20px auto;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            font-family: inherit;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .search-clear:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* Surlignage des termes recherch√©s */
        mark {
            background: #e3f2fd;
            color: #1565c0;
            padding: 0;
            border-radius: 0;
            font-weight: 600;
            border: none;
        }

        /* Style pour les articles hors liste */
        .custom-desc-input {
            width: calc(100% - 16px); /* Ajust√© pour le padding */
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .custom-desc-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }
        
        .custom-desc-input:disabled {
            background: #f5f5f5;
            color: #999;
        }
        
        /* Cacher la saisie de description des articles hors liste √† l'impression */
        @media print {
            .custom-desc-input { display: none !important; }
            #customItemsSection .item:not(.selected) { display: none !important; }
            #customItemsSection.hide-on-print { display: none !important; }
        }

        /* (panneau d'√©dition retir√©) */

        /* Zone de notification discr√®te */
        .notice { margin: 10px 25px; padding: 10px 12px; border-radius: 6px; display: none; font-size: 13px; }
        .notice.info { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
        .notice.warn { background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; }
        .notice.error { background: #fef2f2; border: 1px solid #fecaca; color: #7f1d1d; }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container { 
                max-width: 100%;
                border-radius: 0; 
            }
            .form-section, .inventory-section, .summary {
                margin: 10px;
                padding: 15px;
            }
            .form-row { grid-template-columns: 1fr; }
            .search-container {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            .search-input-wrapper {
                width: 100%;
            }
            .btn-history-search {
                font-size: 12px;
                padding: 8px 14px;
                align-self: center;
                min-width: 120px;
            }
            .item { 
                grid-template-columns: 25px 1fr 60px 60px;
                grid-template-rows: auto auto;
                gap: 8px;
                padding: 8px 4px;
            }
            .item input[type="checkbox"] {
                grid-column: 1;
                grid-row: 1;
            }
            .item-details {
                grid-column: 2;
                grid-row: 1;
            }
            .item-max {
                grid-column: 3;
                grid-row: 1;
                font-size: 10px;
                padding: 1px 6px;
            }
            .item-price { 
                grid-column: 4;
                grid-row: 1;
                text-align: right;
                font-size: 13px;
                align-self: start;
                padding-right: 4px;
            }
            .qty-controls { 
                display: flex !important;
                grid-column: 1 / -1;
                grid-row: 2;
                justify-self: center;
                margin-top: 5px;
                gap: 2px;
                width: auto;
                align-items: center;
                flex-wrap: nowrap;
            }
            .qty-btn {
                display: flex !important;
                width: 22px;
                height: 20px;
                font-size: 9px;
            }
            .item-qty {
                width: 32px;
                font-size: 12px;
                margin: 0 2px;
            }
            .controls { 
                flex-direction: column; 
                gap: 8px;
            }
            .btn { 
                width: 100%;
                padding: 10px 20px;
                font-size: 14px;
            }
            .summary-content {
                grid-template-columns: 1fr;
            }
        }

        /* --- STYLES SP√âCIFIQUES POUR L'IMPRESSION --- */
        @media print {
            @page {
                size: 8.5in 11in;
                margin: 0.75in 0.75in 1in 0.75in;
            }

            body {
                background: white; color: black; padding: 0;
                font-size: 9pt;
                font-family: 'Merriweather', serif;
                line-height: 1.4;
            }

            .container, .content-wrapper, #inventoryContainer {
                width: 100%; max-width: 100%; box-shadow: none; border-radius: 0;
                display: block;
            }

            .controls, .qty-controls, .item input[type="checkbox"], .summary, .header p, .item-max, .special-input, .search-container {
                display: none !important;
            }
            
            /* Masquer les placeholders √† l'impression */
            textarea::placeholder, input::placeholder {
                color: transparent !important;
                opacity: 0 !important;
            }
            
            /* Classe pour masquer la section commentaires vide √† l'impression */
            .comments-empty-print {
                display: none !important;
            }
            
            /* Masquer sp√©cifiquement les containers de cases √† cocher "√† l'unit√©" */
            .unit-toggle-container {
                display: none !important;
            }
            
            /* Masquer les couleurs Tubifast √† l'impression */
            .tubifast-colors {
                display: none !important;
            }
            
            .item:not(.selected), .category.hide-on-print {
                display: none !important;
            }

            .print-only, .print-special-value, .print-unit-name { display: inline !important; }
            
            .header {
                background: none; color: black; text-align: center;
                padding: 0 0 10px 0; border-bottom: 2px solid black;
                margin-bottom: 15px;
            }
            .header h1 { 
                font-size: 18pt; 
                text-align: center; 
                margin: 0;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .form-section {
                padding: 10px 0;
                border: none;
                border-bottom: 1px solid #000;
                margin: 0 0 10px 0;
                background: transparent;
            }
            .form-row {
                display: grid; grid-template-columns: 1fr 1fr;
                gap: 8px 30px; margin: 0; font-size: 10pt;
            }
            .form-group {
                display: flex; flex-direction: row; align-items: baseline; gap: 8px;
            }
            .form-group label {
                font-size: 10pt; font-weight: bold; margin: 0;
                min-width: 70px;
            }
            .form-group input {
                border: none; border-bottom: 1px solid #666;
                border-radius: 0; padding: 2px 0; font-size: 10pt;
                flex-grow: 1;
                background: transparent;
                font-weight: 500;
            }
            
            .form-group textarea {
                border: 1px solid #666;
                border-radius: 0; padding: 8px 4px; font-size: 9pt;
                background: transparent;
                font-family: inherit;
                resize: none;
                min-height: 60px;
            }
            
            #comments-section {
                padding: 15px 0;
                border: none;
                border-top: 1px solid #000;
                margin: 10px 0;
                background: transparent;
                page-break-inside: avoid;
            }
            
            .inventory-section { 
                padding: 15px 0 40px 0; 
                border: none;
                margin: 0;
                background: transparent;
            } /* Espace pour le footer fixe */
            
            /* === AM√âLIORATION : Meilleur contr√¥le des sauts de page === */
            .category { 
                page-break-inside: avoid;
                page-break-after: auto;
                /* √âviter les orphelins : garder au moins 3 lignes ensemble */
                orphans: 3;
                widows: 3;
            }
            
            /* √âviter de commencer une nouvelle cat√©gorie en bas de page */
            .category h3 {
                page-break-after: avoid;
                /* === FIN AM√âLIORATION === */
                font-size: 10pt; 
                background: #f5f5f5; 
                color: black;
                margin: 14px 0 8px 0; 
                border: none;
                padding: 5px 8px;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .item {
                display: flex;
                flex-direction: row;
                align-items: baseline;
                gap: 6px;
                border: none;
                padding: 3px 0;
                page-break-inside: avoid;
                font-size: 9pt;
                line-height: 1.4;
            }
            
            .item:not(:last-child) {
                border-bottom: 1px dotted #ccc;
            }
            
            .item::before {
                content: attr(data-print-qty) " x";
                font-weight: bold;
                color: black;
                min-width: 25px;
                text-align: right;
                margin-right: 8px;
                font-size: 8.5pt;
            }
            
            #customItemsSection .item-name .print-special-value {
                display: inline !important;
            }
            
            .item-details { flex-grow: 1; }
            .item-price { 
                min-width: 50px; 
                text-align: right; 
                font-size: 8pt; 
                color: #000;
                margin-left: auto;
                padding-left: 8px;
            }
            
            .item-name { 
                display: inline;
                font-size: 9pt;
                font-weight: 500;
            }
            .special-inputs { display: inline-flex; gap: 3px; margin-left: 5px; }
            
            .print-special-value {
                font-size: 8pt;
                font-style: italic;
                padding: 0 2px;
                border-bottom: 1px dotted #888;
            }
            
            /* Style sp√©cifique pour les articles hors liste en impression */
            #customItemsSection .item-name .print-special-value {
                font-size: 9pt;
                font-style: normal;
                font-weight: 500;
                padding: 0;
                border-bottom: none;
            }

            #print-summary {
                display: none; /* Cach√© par d√©faut */
            }
            
            /* Conteneur pour le total qui appara√Æt seulement √† la fin */
            .print-total-end {
                margin-top: 25px;
                padding-top: 8px;
                border-top: 2px solid black;
                text-align: right;
                font-size: 10pt;
                font-weight: bold;
                page-break-inside: avoid;
                display: none;
            }
            
            /* Affiche le total seulement en impression */
            @media print {
                .print-total-end {
                    display: block !important;
                }
            }
            
            /* === MODE CONDENS√â : Optimis√© pour √©viter d√©bordements === */
            html.print-condensed body {
                font-size: 8pt; 
                line-height: 1.2; /* R√©duit de 1.3 √† 1.2 */
            }
            html.print-condensed .item { 
                padding: 1px 0; /* R√©duit de 2px √† 1px */
                font-size: 7.5pt; 
            }
            html.print-condensed .item-name {
                font-size: 7.5pt;
            }
            html.print-condensed .category h3 {
                font-size: 8.5pt; /* R√©duit de 9pt √† 8.5pt */
                padding: 3px 6px; /* R√©duit de 4px √† 3px */
                margin: 6px 0 3px 0; /* R√©duit les marges */
                background: #f8f8f8;
            }
            html.print-condensed .item::before {
                font-size: 7pt;
                min-width: 20px;
            }
            html.print-condensed .item-price {
                font-size: 6.5pt; /* R√©duit de 7pt √† 6.5pt */
                min-width: 45px;
            }
            /* === FIN AM√âLIORATION MODE CONDENS√â === */

            html.print-multicolumn .inventory-section {
                column-count: 2;
                column-gap: 25px;
                column-rule: 1px solid #ddd;
                margin-bottom: 50px; /* Espace pour le footer */
            }
            html.print-multicolumn .category {
                break-inside: avoid-column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>R√©quisition de mat√©riel</h1>
            <p>SAD-PA - Derni√®re mise √† jour le 20 octobre 2025</p>
        </div>
        
        <div class="form-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="nomIntervenant">Intervenant:</label>
                    <input type="text" id="nomIntervenant" name="nomIntervenant">
                </div>
                <div class="form-group">
                    <label for="client">Client:</label>
                    <input type="text" id="client" name="client">
                </div>
            </div>
             <div class="form-row">
                <div class="form-group">
                    <label for="poste">Poste:</label>
                    <input type="text" id="poste" name="poste">
                </div>
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date">
                </div>
            </div>
            <div id="form-error" class="form-error" aria-live="polite" role="status"></div>
        </div>

        <div class="inventory-section">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" placeholder="Rechercher des articles..." class="search-input">
                    <button id="clearSearch" class="search-clear" title="Effacer la recherche">√ó</button>
                </div>
                <button class="btn btn-history-search" onclick="showHistory()" title="Voir l'historique des requ√™tes">
                    üìã Historique
                </button>
            </div>
            <div id="inventoryContainer"></div>
            <!-- Articles Hors Liste -->
            <div class="category" id="customItemsSection" style="margin-top: 25px;">
                <h3>Articles hors liste</h3>
                <div class="items-grid" id="customItemsList"></div>
            </div>
        </div>

        <div class="form-section" id="comments-section" style="border-top: 2px solid #e0e0e0; margin-top: 20px;">
            <div class="form-group" style="width: 100%;">
                <label for="commentaires" style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 14px;">Commentaires:</label>
                <textarea id="commentaires" name="commentaires" rows="4" 
                         placeholder="Commentaires additionnels, instructions sp√©ciales, observations, etc."
                         style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; 
                                font-size: 14px; font-family: inherit; resize: vertical; min-height: 100px;
                                transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;"
                         onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.25)'; this.style.backgroundColor='#fafbff';"
                         onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none'; this.style.backgroundColor='white';"
                         title="Navigation clavier d√©sactiv√©e dans ce champ - tapez librement"></textarea>
            </div>
        </div>

        <div id="summary" class="summary" style="display: none;">
            <h4>R√©sum√© de la s√©lection</h4>
            <div id="summaryContent" class="summary-content"></div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="clearAll()">Effacer tout</button>
            <button class="btn btn-primary" onclick="sendRequisitionEmail()">Envoyer par courriel</button>
            <button class="btn btn-info" onclick="toggleKeyboardHelp()" title="Afficher l'aide clavier">‚å®Ô∏è Aide</button>
        </div>

        <div id="page-notice" class="notice" role="status" aria-live="polite"></div>
        
        <div id="keyboard-help" style="display: none; margin: 15px 25px; padding: 15px; background: #f0f8ff; border: 1px solid #0066cc; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #0066cc;">Raccourcis clavier</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; font-size: 13px;">
                <div><strong>‚Üë‚Üì‚Üê‚Üí / WASD</strong> : Naviguer entre les articles</div>
                <div><strong>Page Up / Page Down</strong> : Sauter 5 articles</div>
                <div><strong>Ctrl+Home / Ctrl+End</strong> : Aller au d√©but/fin</div>
                <div><strong>Espace / Enter / Numpad 5</strong> : S√©lectionner/d√©s√©lectionner</div>
                <div><strong>Q / -</strong> : Quantit√© -1</div>
                <div><strong>E / +</strong> : Quantit√© +1</div>
                <div><strong>Molette souris</strong> : +/- 1 sur le champ quantit√© (Shift: +/- 5)</div>
                <div><strong>Esc</strong> : Retirer le focus</div>
            </div>
        </div>

        <!-- Modal Historique -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Historique des requ√™tes</h3>
                    <button class="modal-close" onclick="closeHistory()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="history-stats" class="history-stats"></div>
                    <div id="history-list" class="history-list"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="clearAllHistory()">Effacer tout l'historique</button>
                    <button class="btn btn-primary" onclick="closeHistory()">Fermer</button>
                </div>
            </div>
        </div>

        <div id="print-summary" class="print-total-end"></div>
    </div>

    <script>
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        const allItems = [
            // ... (Toutes vos donn√©es d'articles restent ici, inchang√©es)
            {cat: 'gants', title: 'Gants', items: [
                {id: 'gant1', name: 'Gants Non-st√©rile Nitrile (petit)', price: '0.99 $', max: 2}, {id: 'gant2', name: 'Gants Non-st√©rile Nitrile (moyen)', price: '0.99 $', max: 2}, {id: 'gant3', name: 'Gants Non-st√©rile Nitrile (grand)', price: '0.99 $', max: 2}, {id: 'gant4', name: 'Gants St√©rile (petit)', price: '0.78 $', max: 10}, {id: 'gant5', name: 'Gants St√©rile (moyen)', price: '0.78 $', max: 10}, {id: 'gant6', name: 'Gants St√©rile (grand)', price: '0.78 $', max: 10}, {id: 'gant7', name: 'Gants St√©rile (x-grand)', price: '0.78 $', max: 10}
            ]},
            {cat: 'sterile', title: 'Fournitures st√©riles', items: [
                {id: 'sterile1', name: 'Abaisse-langue', price: '0.02 $', max: 10}, {id: 'sterile2', name: 'Bistouri #15', price: '0.58 $', max: 10}, {id: 'sterile3', name: 'Cabaret √† pansement', price: '5.38 $', max: 10}, {id: 'sterile4', name: 'Kit √† point (ciseau + pince)', price: '0.76 $', max: 10}, {id: 'sterile5', name: 'Pot orange', price: '0.26 $', max: 10}, {id: 'sterile6', name: 'Tige Dacron (en plastique)', price: '0.17 $', max: 10}, {id: 'sterile7', name: 'Tige mont√©e en bois', price: '0.02 $', max: 10}, {id: 'sterile8', name: 'Mousse antiseptique', price: '2.55 $', max: 1}, {id: 'sterile9', name: 'Embout pour irrigation', price: '1.57 $', max: 20}
            ]},
            {cat: 'iv', title: 'Fournitures IV / IM / S/C', items: [
                {id: 'iv1', name: 'Aiguille', price: '-', max: 5, specialInput: { type: 'gauge' }}, {id: 'iv2', name: 'Cath√©ter IV', price: '-', max: 5, specialInput: { type: 'gauge' }}, {id: 'iv3', name: 'Seringue Luer-Lock (bout viss√©)', price: '-', max: 20, specialInput: { type: 'volume' }}
            ]},
            {cat: 'adhesif', title: 'Adh√©sifs', items: [
                {id: 'adhesif1', name: 'Diachylon rapprochement ¬º', price: '0.63 $', max: 2}, {id: 'adhesif2_rouleau', name: 'Hypafix (rouleau)', price: '0.43 $', max: 3}, {id: 'adhesif2_boite', name: 'Hypafix (bo√Æte)', price: '21.50 $', max: 1}, {id: 'adhesif3', name: 'IV 3000 max', price: '0.92 $', max: 20}, {id: 'adhesif4', name: 'Micropore 1"', price: '0.48 $', max: 1}, {id: 'adhesif5', name: 'Tegaderm (petit)', price: '0.13 $', max: 4}, {id: 'adhesif6', name: 'Tegaderm (moyen)', price: '0.58 $', max: 10}, {id: 'adhesif7', name: 'Tegaderm (grand)', price: '3.49 $', max: 7}, {id: 'adhesif8', name: 'Transpore 1"', price: '0.51 $', max: 1}
            ]},
            {cat: 'nettoyage', title: 'Agents de nettoyage', items: [
                {id: 'nettoyage1', name: 'Alcool (tampon)', price: '0.01 $', max: 30}, {id: 'nettoyage2', name: 'Chlorhexidine (tampon)', price: '0.23 $', max: 5}, {id: 'nettoyage3', name: 'Chlorhexidine (tige)', price: '0.42 $', max: 8}, {id: 'nettoyage4', name: 'Dissolvant (tampon)', price: '0.06 $', max: 5}, {id: 'nettoyage5', name: 'Eau st√©rile 500 ml', price: '4.57 $', max: 7}, {id: 'nettoyage6', name: 'Irilin gl. chlorh. 0.05%', price: '5.44 $', max: 1}, {id: 'nettoyage7', name: 'NaCl .9% 5 ml (fiole rose)', price: '0.26 $', max: 10}, {id: 'nettoyage8', name: 'NaCl .9% Irriguo 60 ml', price: '0.72 $', max: 10}, {id: 'nettoyage9', name: 'NaCl .9% 500 ml', price: '3.51 $', max: 7}, {id: 'nettoyage10', name: 'Proviodine (bouteille)', price: '1.44 $', max: 1}, {id: 'nettoyage11', name: 'Proviodine (tampon)', price: '0.23 $', max: 10}, {id: 'nettoyage12', name: 'P√¢te Triad', price: '8.13 $', max: 1}, {id: 'nettoyage13', name: 'Vaseline (tube)', price: '0.95 $', max: 1}
            ]},
            {cat: 'nonst√©rile', title: 'Fournitures non-st√©riles', items: [
                {id: 'nonst√©rile1', name: 'Contenant aiguille (petit)', price: '1.37 $', max: 1}, {id: 'nonst√©rile2', name: 'Contenant pour cytotoxique', price: '6.24 $', max: 1}, {id: 'nonst√©rile3', name: 'Jaquette jaune', price: '0.33 $', max: 10}, {id: 'nonst√©rile4', name: 'Masque', price: '-', max: 10}, {id: 'nonst√©rile5', name: 'Sac de plastique', price: '0.05 $', max: 10}, {id: 'nonst√©rile6', name: 'Pot jaune', price: '0.23 $', max: 10}, {id: 'nonst√©rile7', name: 'Piqu√© bleu', price: '0.30 $', max: 10}
            ]},
            {cat: 'compressif', title: 'Compressif / Tubibast / Filet', items: [
                {id: 'compressif1', name: 'Coban 4"', price: '4.83 $', max: 18}, {id: 'compressif2', name: 'Coban 2', price: '12.99 $', max: 18}, {id: 'compressif3', name: 'Coban 2 lite', price: '12.99 $', max: 18}, {id: 'compressif4', name: 'Filet', price: '-', max: 2, specialInput: { type: 'filet' }}, {id: 'compressif5', name: 'Ouatine orthop√©dique', price: '1.25 $', max: 18}, {id: 'compressif6', name: 'Tubifast', price: '-', max: 4, specialInput: { type: 'tubifast' }}, {id: 'compressif7', name: 'Tubigrip', price: '-', max: 4, specialInput: { type: 'tubigrip' }}
            ]},
            {cat: 'barri√®re', title: 'Barri√®re cutan√©e / Gel', items: [
                {id: 'barri√®re1', name: 'Critic Aid', price: '2.40 $', max: 1}, {id: 'barri√®re2', name: 'Skin prep (tampon)', price: '0.15 $', max: 10}, {id: 'barri√®re3', name: 'Intrasite gel', price: '2.40 $', max: 1}, {id: 'barri√®re4', name: 'Cr√®me Baza (140g)', price: '4.60 $', max: 1}
            ]},
            {cat: 'pansement', title: 'Pansements', items: [
                {id: 'pansement1', name: 'Actisorb (10,5 x 10,5 cm)', price: '4.44 $', max: 5}, {id: 'pansement2', name: 'Adaptic Touch (7,5 x 5 cm)', price: '1.73 $', max: 5}, {id: 'pansement3', name: 'Bactigras (5 x 5cm)', price: '0.70 $', max: 5}, {id: 'pansement4', name: 'Bactigras (10 x 10 cm)', price: '1.28 $', max: 5}, {id: 'pansement5', name: 'Allevyn (10x10 cm)', price: '1.37 $', max: 8}, {id: 'pansement6', name: 'Biatain silicone (12,5x12,5 cm)', price: '2.24 $', max: 8}, {id: 'pansement7', name: 'Biatain silicone lite (7,5 x 7,5cm)', price: '1.11 $', max: 8}, {id: 'pansement8', name: 'Biatain silicone lite (12,5 x 12,5)', price: '3.12 $', max: 8}, {id: 'pansement9', name: 'Biatain silicone Ag (12,5 x 12,5)', price: '6.98 $', max: 5}, {id: 'pansement10', name: 'Compresse non st√©rile 4x4', price: '3.17 $', max: 1}, {id: 'pansement11', name: 'Compresse non st√©rile 4x8', price: '9.41 $', max: 1}, {id: 'pansement12', name: 'Bo√Æte de compresses st√©riles 2 x 2', price: '1.50 $', priceUnit: '0.03 $', max: 2, specialInput: {type: 'unit_toggle', unitMax: 100}}, {id: 'pansement13', name: 'Bo√Æte de compresses st√©riles 3 x 3', price: '3.00 $', priceUnit: '0.06 $', max: 2, specialInput: {type: 'unit_toggle', unitMax: 100}}, {id: 'pansement14', name: 'Bo√Æte de compresses st√©riles 4 x 4', price: '3.50 $', priceUnit: '0.07 $', max: 2, specialInput: {type: 'unit_toggle', unitMax: 100}}, {id: 'pansement15', name: 'Bo√Æte de compresses st√©riles 4 x 8', price: '9.50 $', priceUnit: '0.19 $', max: 2, specialInput: {type: 'unit_toggle', unitMax: 100}}, {id: 'pansement16', name: 'Compresse √† drain 3 x 3', price: '0.57 $', max: 10}, {id: 'pansement17', name: 'Compresse √† drain 4 x 4', price: '0.15 $', max: 10}, {id: 'pansement18', name: 'Duoderm x-mince (10x10 cm)', price: '0.98 $', max: 3}, {id: 'pansement19', name: 'Inadine (5 x 5 cm)', price: '1.37 $', max: 7}, {id: 'pansement20', name: 'Inadine (9,5 x 9,5 cm)', price: '2.27 $', max: 7}, {id: 'pansement21', name: 'Iodosorb (10g)', price: '14.27 $', max: 2}, {id: 'pansement22', name: 'Acticoat Flex', price: '5.28 $', max: 2}
            ]},
            {cat: 'pansement2', title: 'Pansements (suite)', items: [
                {id: 'kling1', name: 'Paquet de Kling non-st√©rile 2"', price: '1.56 $', priceUnit: '0.13 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 6}}, {id: 'kling2', name: 'Paquet de Kling non-st√©rile 3"', price: '2.16 $', priceUnit: '0.18 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 6}}, {id: 'kling3', name: 'Paquet de Kling non-st√©rile 4"', price: '2.52 $', priceUnit: '0.21 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 6}}, {id: 'kling4', name: 'Paquet de Kling non-st√©rile 6"', price: '3.60 $', priceUnit: '0.30 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 6}}, {id: 'pansement2_5', name: 'Mepilex (20 x 20 cm)', price: '8.34 $', max: 3}, {id: 'pansement2_6', name: 'Mepore - Petit (6x7cm)', price: '0.09 $', max: 7}, {id: 'pansement2_7', name: 'Mepore - Grand (9x10cm)', price: '0.15 $', max: 7}, {id: 'pansement2_8', name: 'Paquet de Pad abdominal (petit)', price: '2.40 $', priceUnit: '0.12 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 20}}, {id: 'pansement2_9', name: 'Paquet de Pad abdominal (grand)', price: '4.20 $', priceUnit: '0.21 $', max: 1, specialInput: {type: 'unit_toggle', unitMax: 20}}, {id: 'pansement2_10', name: 'M√®che 1/4 po AMD', price: '1.69 $', max: 8}, {id: 'pansement2_11', name: 'M√®che ¬º pouce', price: '3.50 $', max: 1}, {id: 'pansement2_12', name: 'M√®che ¬Ω pouce', price: '1.68 $', max: 1}, {id: 'pansement2_13', name: 'M√®che 1 pouce', price: '1.62 $', max: 1}, {id: 'pansement2_14', name: 'M√®che iodoform√©e 1/4 po', price: '4.49 $', max: 1}, {id: 'pansement2_15', name: 'M√®che iodoform√©e 1/2 po', price: '4.79 $', max: 1}, {id: 'pansement2_16', name: 'Tegaderm absorbant (petit)', price: '3.96 $', max: 3}, {id: 'pansement2_17', name: 'Tegaderm absorbant (moyen)', price: '6.29 $', max: 1}, {id: 'pansement2_18', name: 'Mepore Pro 6x7cm', price: '0.11 $', max: 7}, {id: 'pansement2_19', name: 'Telfa (moyen) 7.5x10cm', price: '0.10 $', max: 5}
            ]},
            {cat: 'urinaire', title: 'Soins urinaires', items: [
                {id: 'urinaire1', name: 'Bouchon sonde', price: '0.17 $', max: 2}, {id: 'urinaire2', name: 'Cabaret √† cath√©t√©risme', price: '2.22 $', max: 2}, {id: 'urinaire3', name: 'Cath√©ter urinaire', price: '4.50 $', max: 10, specialInput: { type: 'french' }}, {id: 'urinaire4', name: 'Cath-Secur', price: '3.36 $', max: 2}, {id: 'urinaire5', name: 'Gel√©e lubrifiante (sachet)', price: '1.50 $', max: 5}, {id: 'urinaire6', name: 'Gel√©e lubrifiante (tube)', price: '1.50 $', max: 1}, {id: 'urinaire7', name: 'Pince √† clamper', price: '-', max: 1}, {id: 'urinaire8', name: 'Sac collecteur de nuit 2L', price: '4.03 $', max: 2}, {id: 'urinaire9', name: 'Sac √† cuisse 500 ml', price: '0.09 $', max: 2}, {id: 'urinaire10', name: 'Sac √† cuisse 1000 ml', price: '0.67 $', max: 2}, {id: 'urinaire11', name: 'Sonde silastic', price: '4.50 $', max: 2, specialInput: { type: 'french' }}, {id: 'urinaire12', name: 'Sonde 100% silicone', price: '4.50 $', max: 2, specialInput: { type: 'french' }}, {id: 'urinaire13', name: 'Seringue 60cc (bout cath√©ter)', price: '0.40 $', max: 4}
            ]}
        ];
        
        // --- Le Javascript ci-dessous est enti√®rement fonctionnel ---

        function createCategory(category) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            let html = `<h3>${category.title}</h3><div class="items-grid">`;
            category.items.forEach(item => {
                let specialInputHTML = '';
                if (item.specialInput) {
                    if (item.specialInput.type === 'filet') {
                        specialInputHTML = `<div class="special-inputs" id="special-${item.id}"><input type="text" placeholder="#" class="special-input" id="filet-num-${item.id}" disabled><input type="text" placeholder="longueur (cm)" class="special-input" id="filet-len-${item.id}" disabled></div>`;
                    } else if (item.specialInput.type === 'tubigrip') {
                        specialInputHTML = `<div class="special-inputs" id="special-${item.id}"><input type="text" placeholder="lettre" class="special-input" id="tubi-letter-${item.id}" disabled><input type="text" placeholder="longueur (cm)" class="special-input" id="tubi-len-${item.id}" disabled></div>`;
                    } else if (item.specialInput.type === 'gauge') {
                        specialInputHTML = `<div class="special-inputs" id="special-${item.id}"><input type="text" placeholder="G" class="special-input" id="gauge-${item.id}" disabled></div>`;
                    } else if (item.specialInput.type === 'french') {
                        specialInputHTML = `<div class="special-inputs" id="special-${item.id}"><input type="text" placeholder="Fr" class="special-input" id="french-${item.id}" disabled></div>`;
                    } else if (item.specialInput.type === 'volume') {
                        specialInputHTML = `<div class="special-inputs" id="special-${item.id}"><input type="text" placeholder="ml" class="special-input" id="volume-${item.id}" disabled></div>`;
                    } else if (item.specialInput.type === 'tubifast') {
                        specialInputHTML = `<div class="special-inputs tubifast-container" id="special-${item.id}" style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="tubifast-colors" style="display: flex; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #667eea; cursor: pointer;">
                                    <input type="checkbox" id="tubifast-jaune-${item.id}" onchange="toggleTubifastColor('${item.id}', 'jaune', this.checked)" disabled style="accent-color: #fbbf24;">
                                    <span>Jaune</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #667eea; cursor: pointer;">
                                    <input type="checkbox" id="tubifast-bleu-${item.id}" onchange="toggleTubifastColor('${item.id}', 'bleu', this.checked)" disabled style="accent-color: #3b82f6;">
                                    <span>Bleu</span>
                                </label>
                            </div>
                            <input type="text" placeholder="longueur (cm)" class="special-input" id="tubifast-len-${item.id}" disabled>
                        </div>`;
                    } else if (item.specialInput.type === 'unit_toggle') {
                        specialInputHTML = `<div class="special-inputs unit-toggle-container" id="special-${item.id}" style="display: flex; align-items: center; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #667eea; cursor: pointer;">
                                <input type="checkbox" id="unit-toggle-${item.id}" onchange="toggleUnitMode('${item.id}', this.checked, ${item.max}, ${item.specialInput.unitMax})" disabled style="accent-color: #667eea;">
                                <span>√† l'unit√©</span>
                            </label>
                        </div>`;
                    }
                }
                html += `
                    <div class="item" data-id="${item.id}">
                        <input type="checkbox" id="${item.id}" onchange="toggleItem(this)">
                        <div class="qty-controls">
                            <button class="qty-btn decrement" onclick="adjustQty('${item.id}', -10)" disabled ${item.max < 10 ? 'style="visibility: hidden;"' : ''}>-10</button>
                            <button class="qty-btn decrement" onclick="adjustQty('${item.id}', -5)" disabled ${item.max < 5 ? 'style="visibility: hidden;"' : ''}>-5</button>
                            <button class="qty-btn decrement" onclick="adjustQty('${item.id}', -1)" disabled>-1</button>
                            <input type="number" class="item-qty" min="0" max="${item.max}" value="1" disabled onchange="updateItemPrice('${item.id}'); updateSummary()">
                            <button class="qty-btn increment" onclick="adjustQty('${item.id}', 1)" disabled>+1</button>
                            <button class="qty-btn increment" onclick="adjustQty('${item.id}', 5)" disabled ${item.max < 5 ? 'style="visibility: hidden;"' : ''}>+5</button>
                            <button class="qty-btn increment" onclick="adjustQty('${item.id}', 10)" disabled ${item.max < 10 ? 'style="visibility: hidden;"' : ''}>+10</button>
                        </div>
                        <div class="item-details">
                            <span class="item-name">${item.name}</span>
                            ${specialInputHTML}
                        </div>
                        <span class="item-max" id="max-label-${item.id}">Max ${item.max}${item.specialInput && item.specialInput.type === 'unit_toggle' ? ' bte' : ''}</span>
                        <span class="item-price" data-box-price="${item.price}" data-unit-price="${item.priceUnit || ''}" id="price-${item.id}">${item.price}</span>
                    </div>
                `;
            });
            html += '</div>';
            categoryDiv.innerHTML = html;
            return categoryDiv;
        }

        function generateAllCategories() {
            const container = document.getElementById('inventoryContainer');
            allItems.forEach(category => {
                container.appendChild(createCategory(category));
            });
        }

        function toggleItem(checkbox) {
            const item = checkbox.closest('.item');
            const qtyButtons = item.querySelectorAll('.qty-btn');
            const qtyInput = item.querySelector('.item-qty');
            const specialInputs = item.querySelectorAll('.special-input');
            const unitToggle = item.querySelector(`#unit-toggle-${checkbox.id}`);
            const tubifastJaune = item.querySelector(`#tubifast-jaune-${checkbox.id}`);
            const tubifastBleu = item.querySelector(`#tubifast-bleu-${checkbox.id}`);
            
            if (checkbox.checked) {
                item.classList.add('selected');
                qtyButtons.forEach(btn => btn.disabled = false);
                specialInputs.forEach(input => input.disabled = false);
                if (unitToggle) unitToggle.disabled = false;
                if (tubifastJaune) tubifastJaune.disabled = false;
                if (tubifastBleu) tubifastBleu.disabled = false;
                qtyInput.disabled = false;
                qtyInput.readOnly = false;
                qtyInput.value = 1;
                updateQtyButtons(checkbox.id);
                updateItemPrice(checkbox.id);
            } else {
                item.classList.remove('selected');
                qtyButtons.forEach(btn => btn.disabled = true);
                specialInputs.forEach(input => { input.disabled = true; input.value = ''; });
                if (unitToggle) {
                    unitToggle.disabled = true;
                    unitToggle.checked = false;
                    // Reset to box mode
                    const itemData = allItems.flatMap(cat => cat.items).find(i => i.id === checkbox.id);
                    if (itemData && itemData.specialInput && itemData.specialInput.type === 'unit_toggle') {
                        document.getElementById(`max-label-${checkbox.id}`).innerHTML = `Max ${itemData.max} bte`;
                        qtyInput.max = itemData.max;
                    }
                }
                if (tubifastJaune) {
                    tubifastJaune.disabled = true;
                    tubifastJaune.checked = false;
                }
                if (tubifastBleu) {
                    tubifastBleu.disabled = true;
                    tubifastBleu.checked = false;
                }
                qtyInput.disabled = true;
                qtyInput.readOnly = true;
                qtyInput.value = 0;
                updateItemPrice(checkbox.id);
            }
            updateSummary();
        }

        function adjustQty(itemId, change) {
            const checkbox = document.getElementById(itemId);
            if (!checkbox.checked) return;
            const item = checkbox.closest('.item');
            const qtyInput = item.querySelector('.item-qty');
            const maxQty = parseInt(qtyInput.max);
            const currentQty = parseInt(qtyInput.value);
            const newQty = Math.max(1, Math.min(maxQty, currentQty + change));
            qtyInput.value = newQty;
            updateQtyButtons(itemId);
            updateItemPrice(itemId);
            updateSummary();
        }

        function updateQtyButtons(itemId) {
            const item = document.querySelector(`.item[data-id="${itemId}"]`);
            if (!item) return;
            const qtyInput = item.querySelector('.item-qty');
            const currentQty = parseInt(qtyInput.value);
            const maxQty = parseInt(qtyInput.max);
            const buttons = item.querySelectorAll('.qty-btn');
            
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                if (button.style.visibility === 'hidden') {
                    return; // Skip hidden buttons
                }
                
                if (onclick.includes('-10')) {
                    button.disabled = currentQty <= 10;
                } else if (onclick.includes('-5')) {
                    button.disabled = currentQty <= 5;
                } else if (onclick.includes('-1')) {
                    button.disabled = currentQty <= 1;
                } else if (onclick.includes('+1')) {
                    button.disabled = currentQty >= maxQty;
                } else if (onclick.includes('+5')) {
                    button.disabled = currentQty + 4 >= maxQty;
                } else if (onclick.includes('+10')) {
                    button.disabled = currentQty + 9 >= maxQty;
                }
            });
        }
        
        function updateItemPrice(itemId) {
            const item = document.querySelector(`.item[data-id="${itemId}"]`);
            if (!item) return;
            
            const qtyInput = item.querySelector('.item-qty');
            const priceElement = document.getElementById(`price-${itemId}`);
            const unitToggle = document.getElementById(`unit-toggle-${itemId}`);
            const qty = parseInt(qtyInput.value) || 0;
            
            if (!priceElement) return;
            
            const boxPrice = priceElement.getAttribute('data-box-price');
            const unitPrice = priceElement.getAttribute('data-unit-price');
            
            let basePrice = boxPrice; // Prix de bo√Æte par d√©faut
            
            // V√©rifier si on est en mode unit√© pour les compresses
            if (unitToggle && unitToggle.checked && unitPrice && unitPrice !== '') {
                basePrice = unitPrice;
            }
            
            if (basePrice && basePrice !== '-' && qty > 0) {
                const priceValue = parseFloat(basePrice.replace('$', '').trim().replace(',', '.'));
                if (!isNaN(priceValue)) {
                    const totalPrice = priceValue * qty;
                    priceElement.textContent = totalPrice.toFixed(2).replace('.', ',') + ' $';
                }
            } else {
                // Remettre le prix de base (bo√Æte ou unit√© selon le toggle)
                if (unitToggle && unitToggle.checked && unitPrice && unitPrice !== '') {
                    priceElement.textContent = unitPrice;
                } else {
                    priceElement.textContent = boxPrice;
                }
            }
        }

        function updateSummary() {
            const selectedItems = document.querySelectorAll('input[type="checkbox"]:checked');
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            const customItems = (typeof getCustomItems === 'function') ? getCustomItems() : [];
            if (selectedItems.length === 0 && customItems.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }
            let total = 0;
            const itemsByColumn = [[], []];
            let currentColumn = 0;
            
            selectedItems.forEach((checkbox, index) => {
                const item = checkbox.closest('.item');
                const name = item.querySelector('.item-name').innerText;
                const priceElement = item.querySelector('.item-price');
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                const unitToggle = item.querySelector('[id^="unit-toggle-"]');
                
                if (qty > 0) {
                    // R√©cup√©rer les prix depuis les attributs data
                    const boxPrice = priceElement.getAttribute('data-box-price');
                    const unitPrice = priceElement.getAttribute('data-unit-price');
                    
                    let basePrice = boxPrice; // Prix de bo√Æte par d√©faut
                    let displayPrice = priceElement.textContent;
                    
                    // D√©terminer le bon prix de base
                    if (unitToggle && unitToggle.checked && unitPrice && unitPrice !== '') {
                        basePrice = unitPrice;
                    }
                    
                    // Afficher le prix total calcul√© dans le r√©sum√©
                    itemsByColumn[currentColumn].push(`<div class="summary-item"><span>${name} (x${qty})</span><span>${displayPrice}</span></div>`);
                    
                    // Calculer le total avec le prix de base
                    if (basePrice && basePrice.includes('$')) {
                        const priceValue = parseFloat(basePrice.replace('$', '').trim().replace(',', '.'));
                        if (!isNaN(priceValue)) { 
                            total += priceValue * qty; 
                        }
                    }
                    currentColumn = (currentColumn + 1) % 2;
                }
            });
            
            // Ajouter les articles hors liste (sans prix)
            customItems.forEach(ci => {
                itemsByColumn[currentColumn].push(`<div class=\"summary-item\"><span>${ci.name} (x${ci.qty})</span><span>-</span></div>`);
                currentColumn = (currentColumn + 1) % 2;
            });

            let summaryHTML = '';
            if (itemsByColumn[0].length > 0) {
                summaryHTML += `<div>${itemsByColumn[0].join('')}</div>`;
            }
            if (itemsByColumn[1].length > 0) {
                summaryHTML += `<div>${itemsByColumn[1].join('')}</div>`;
            }
            summaryHTML += `<div class="summary-total">Total estim√© : ${total.toFixed(2).replace('.', ',')} $</div>`;
            summaryContent.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
        }
        
        function toggleUnitMode(itemId, isUnitMode, boxMax, unitMax) {
            const item = document.getElementById(itemId).closest('.item');
            const qtyInput = item.querySelector('.item-qty');
            const maxLabel = document.getElementById(`max-label-${itemId}`);
            const qtyButtons = item.querySelectorAll('.qty-btn');
            
            if (isUnitMode) {
                // Mode unit√©
                qtyInput.max = unitMax;
                maxLabel.innerHTML = `Max ${unitMax}`;
                // R√©initialiser la valeur si elle d√©passe le nouveau max
                if (parseInt(qtyInput.value) > unitMax) {
                    qtyInput.value = unitMax;
                }
                // Afficher/masquer les boutons selon le nouveau max
                qtyButtons.forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    if (onclick.includes('+5')) {
                        button.style.visibility = unitMax >= 5 ? 'visible' : 'hidden';
                    } else if (onclick.includes('+10')) {
                        button.style.visibility = unitMax >= 10 ? 'visible' : 'hidden';
                    }
                });
            } else {
                // Mode bo√Æte
                qtyInput.max = boxMax;
                maxLabel.innerHTML = `Max ${boxMax} bte`;
                // R√©initialiser la valeur si elle d√©passe le nouveau max
                if (parseInt(qtyInput.value) > boxMax) {
                    qtyInput.value = boxMax;
                }
                // Afficher/masquer les boutons selon le nouveau max
                qtyButtons.forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    if (onclick.includes('+5')) {
                        button.style.visibility = boxMax >= 5 ? 'visible' : 'hidden';
                    } else if (onclick.includes('+10')) {
                        button.style.visibility = boxMax >= 10 ? 'visible' : 'hidden';
                    }
                });
            }
            
            // Mettre √† jour l'√©tat des boutons et le prix
            updateQtyButtons(itemId);
            updateItemPrice(itemId);
            updateSummary();
        }
        
        function toggleTubifastColor(itemId, color, checked) {
            // Cette fonction peut √™tre utilis√©e pour des validations ou actions futures
            // Pour l'instant, elle permet simplement de cocher/d√©cocher les couleurs
            // Les deux couleurs peuvent √™tre s√©lectionn√©es simultan√©ment
        }
        
        function clearAll() {
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
                toggleItem(cb);
            });
            ['nomIntervenant', 'poste', 'client', 'commentaires'].forEach(id => document.getElementById(id).value = '');
            
            // R√©initialiser la recherche
            clearSearch();

            // R√©initialiser les articles hors liste: conserver 1 ligne vide
            // Attendre un peu pour que le nettoyage de recherche soit termin√©
            setTimeout(() => {
                if (typeof resetCustomItems === 'function') {
                    resetCustomItems();
                }
            }, 10);

            updateSummary();
        }
        
        function generateRequisitionText() {
            const formData = {
                nomIntervenant: document.getElementById('nomIntervenant').value || 'N/A',
                poste: document.getElementById('poste').value || 'N/A',
                client: document.getElementById('client').value || 'N/A',
                date: document.getElementById('date').value,
                commentaires: document.getElementById('commentaires').value.trim() || ''
            };
            let text = `R√âQUISITION DE MAT√âRIEL - SAD-PA\n===================================\nDate: ${formData.date}\nIntervenant: ${formData.nomIntervenant}\nPoste: ${formData.poste}\nClient: ${formData.client}\n\nARTICLES DEMAND√âS :\n-----------------------------------\n\n`;
            let total = 0;
            const selectedByCategory = {};
            
            // === CORRECTION BUG TEXT: Parcourir les articles s√©lectionn√©s ===
            const selectedEls = document.querySelectorAll('.item.selected');
            selectedEls.forEach(itemElement => {
                const checkbox = itemElement.querySelector('input[type="checkbox"]');
                if (!checkbox) return; // Article hors liste
                
                const parentCategory = itemElement.closest('.category');
                if (parentCategory && !parentCategory.querySelector('.item.selected')) {
                    return;
                }
                
                const qty = parseInt(itemElement.querySelector('.item-qty').value);
                if (qty <= 0) return;
                
                // Trouver l'article dans allItems
                const itemId = checkbox.id;
                let item = null;
                let categoryTitle = '';
                
                for (const category of allItems) {
                    const found = category.items.find(i => i.id === itemId);
                    if (found) {
                        item = found;
                        categoryTitle = category.title;
                        break;
                    }
                }
                
                if (!item || !categoryTitle) return;
                
                if (!selectedByCategory[categoryTitle]) { 
                    selectedByCategory[categoryTitle] = []; 
                }
                
                let itemNameForExport = item.name;
                if (item.specialInput) {
                    if (item.specialInput.type === 'filet') { const num = document.getElementById(`filet-num-${item.id}`).value || '[#]'; const len = document.getElementById(`filet-len-${item.id}`).value || '[longueur]'; itemNameForExport = `Filet #${num} (longueur: ${len} cm)`;
                    } else if (item.specialInput.type === 'tubigrip') { const letter = document.getElementById(`tubi-letter-${item.id}`).value || '[lettre]'; const len = document.getElementById(`tubi-len-${item.id}`).value || '[longueur]'; itemNameForExport = `Tubigrip ${letter} (longueur: ${len} cm)`;
                    } else if (item.specialInput.type === 'gauge') { const gauge = document.getElementById(`gauge-${item.id}`).value || '[G]'; itemNameForExport = `${item.name} ${gauge}G`;
                    } else if (item.specialInput.type === 'french') { const fr = document.getElementById(`french-${item.id}`).value || '[Fr]'; itemNameForExport = `${item.name} ${fr}Fr`;
                    } else if (item.specialInput.type === 'volume') { const vol = document.getElementById(`volume-${item.id}`).value || '[ml]'; itemNameForExport = `${item.name} ${vol}ml`; }
                }
                selectedByCategory[categoryTitle].push({ name: itemNameForExport, qty: qty });
                if (item.price.includes('$')) {
                    const priceValue = parseFloat(item.price.replace('$', '').trim().replace(',', '.'));
                    if (!isNaN(priceValue)) { total += priceValue * qty; }
                }
            });
            // === FIN CORRECTION BUG TEXT ===
            Object.keys(selectedByCategory).forEach(categoryName => {
                text += `--- ${categoryName.toUpperCase()} ---\n`;
                selectedByCategory[categoryName].forEach(item => {
                    text += `- ${item.name} (Quantit√© : ${item.qty})\n`;
                });
                text += '\n';
            });
            // Ajouter les articles hors liste
            const customItems = (typeof getCustomItems === 'function') ? getCustomItems() : [];
            if (customItems.length > 0) {
                text += `--- ARTICLES HORS LISTE ---\n`;
                customItems.forEach(ci => {
                    text += `- ${ci.name} (Quantit√© : ${ci.qty})\n`;
                });
                text += '\n';
            }
            
            // Ajouter les commentaires s'il y en a
            if (formData.commentaires) {
                text += `--- COMMENTAIRES ---\n${formData.commentaires}\n\n`;
            }
            
            text += `===================================\nTotal estim√© : ${total.toFixed(2).replace('.', ',')} $\nG√©n√©r√© le ${new Date().toLocaleString('fr-CA')}`;
            return text;
        }

        function generatePDF() {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuration de base
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let yPosition = margin;
                
                // En-t√™te
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('R√âQUISITION DE MAT√âRIEL', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('SAD-PA', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;
                
                // Informations du formulaire
                const formData = {
                    nomIntervenant: document.getElementById('nomIntervenant').value || 'N/A',
                    poste: document.getElementById('poste').value || 'N/A',
                    client: document.getElementById('client').value || 'N/A',
                    date: document.getElementById('date').value,
                    commentaires: document.getElementById('commentaires').value.trim() || ''
                };
                
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.text(`Intervenant: ${formData.nomIntervenant}`, margin, yPosition);
                doc.text(`Client: ${formData.client}`, pageWidth / 2, yPosition);
                yPosition += 6;
                doc.text(`Poste: ${formData.poste}`, margin, yPosition);
                doc.text(`Date: ${formData.date}`, pageWidth / 2, yPosition);
                yPosition += 15;
                
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Articles s√©lectionn√©s
                const selectedItems = document.querySelectorAll('.item.selected');
                const itemsByCategory = {};
                let total = 0;
                
                // === CORRECTION BUG PDF: Parcourir les articles s√©lectionn√©s ===
                selectedItems.forEach(itemElement => {
                    const checkbox = itemElement.querySelector('input[type="checkbox"]');
                    if (!checkbox) return; // Article hors liste
                    
                    // V√©rifier que la cat√©gorie parente sera affich√©e
                    const parentCategory = itemElement.closest('.category');
                    if (parentCategory && !parentCategory.querySelector('.item.selected')) {
                        return;
                    }
                    
                    const qty = parseInt(itemElement.querySelector('.item-qty').value);
                    if (qty <= 0) return;
                    
                    // Trouver les infos de l'article dans allItems
                    const itemId = checkbox.id;
                    let item = null;
                    let categoryTitle = '';
                    
                    for (const category of allItems) {
                        const found = category.items.find(i => i.id === itemId);
                        if (found) {
                            item = found;
                            categoryTitle = category.title;
                            break;
                        }
                    }
                    
                    if (!item || !categoryTitle) return;
                    
                    if (!itemsByCategory[categoryTitle]) {
                        itemsByCategory[categoryTitle] = [];
                    }
                    
                    const unitToggle = document.getElementById(`unit-toggle-${item.id}`);
                    
                    let itemNameForPDF = item.name;
                    let basePrice = item.price;
                    
                    // G√©rer le mode unit√©/bo√Æte pour les compresses et Kling
                    if (unitToggle && unitToggle.checked && item.priceUnit) {
                        if (item.name.includes('Bo√Æte de')) {
                            itemNameForPDF = item.name.replace('Bo√Æte de ', '') + ' (√† l\'unit√©)';
                        } else if (item.name.includes('Paquet de')) {
                            itemNameForPDF = item.name.replace('Paquet de ', '') + ' (√† l\'unit√©)';
                        }
                        basePrice = item.priceUnit;
                    }
                    
                    if (item.specialInput) {
                        const specialInputs = itemElement.querySelectorAll('.special-input');
                        let specialValues = [];
                        
                        // G√©rer les couleurs Tubifast
                        if (item.specialInput.type === 'tubifast') {
                            const tubifastJaune = document.getElementById(`tubifast-jaune-${item.id}`);
                            const tubifastBleu = document.getElementById(`tubifast-bleu-${item.id}`);
                            let colors = [];
                            if (tubifastJaune && tubifastJaune.checked) colors.push('Jaune');
                            if (tubifastBleu && tubifastBleu.checked) colors.push('Bleu');
                            if (colors.length > 0) {
                                specialValues.push(colors.join(' + '));
                            }
                        }
                        
                        // G√©rer les autres inputs sp√©ciaux
                        specialInputs.forEach(input => {
                            if (input.value) {
                                let value = input.value;
                                const id = input.id;
                                if (id.startsWith('gauge-')) value += ' G';
                                else if (id.startsWith('filet-len-') || id.startsWith('tubi-len-') || id.startsWith('tubifast-len-')) value += ' cm';
                                else if (id.startsWith('french-')) value += ' Fr';
                                specialValues.push(value);
                            }
                        });
                        
                        if (specialValues.length > 0) {
                            itemNameForPDF += ` (${specialValues.join(', ')})`;
                        }
                    }
                    
                    // Calculer le prix total
                    let itemTotal = '-';
                    if (basePrice.includes('$')) {
                        const priceValue = parseFloat(basePrice.replace('$', '').trim().replace(',', '.'));
                        if (!isNaN(priceValue)) {
                            const calculatedTotal = priceValue * qty;
                            total += calculatedTotal;
                            itemTotal = calculatedTotal.toFixed(2).replace('.', ',') + ' $';
                        }
                    }
                    
                    itemsByCategory[categoryTitle].push({
                        name: itemNameForPDF,
                        qty: qty,
                        price: itemTotal
                    });
                });
                // === FIN CORRECTION BUG PDF ===
                
                // √âcrire les cat√©gories et articles
                Object.keys(itemsByCategory).forEach(categoryName => {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(11);
                    doc.text(categoryName.toUpperCase(), margin, yPosition);
                    yPosition += 8;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    
                itemsByCategory[categoryName].forEach(item => {
                    if (yPosition > 270) { // Nouvelle page si n√©cessaire
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    const itemText = `${item.qty} x ${item.name}`;
                    doc.text(itemText, margin + 5, yPosition);
                    doc.text(item.price, pageWidth - margin - 20, yPosition, { align: 'right' });
                    yPosition += 5;
                });
                yPosition += 5;
            });

            // Ajouter les articles hors liste (sans prix)
            const customItemsForPdf = (typeof getCustomItems === 'function') ? getCustomItems() : [];
            if (customItemsForPdf.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                if (yPosition > 270) { doc.addPage(); yPosition = margin; }
                doc.text('ARTICLES HORS LISTE', margin, yPosition);
                yPosition += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                customItemsForPdf.forEach(ci => {
                    if (yPosition > 270) { doc.addPage(); yPosition = margin; }
                    const itemText = `${ci.qty} x ${ci.name}`;
                    doc.text(itemText, margin + 5, yPosition);
                    yPosition += 5;
                });
                yPosition += 5;
            }

            // Ajouter les commentaires s'il y en a
            if (formData.commentaires) {
                if (yPosition > 240) { doc.addPage(); yPosition = margin; }
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('COMMENTAIRES', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                // Diviser les commentaires en lignes pour √©viter le d√©bordement
                const maxWidth = pageWidth - (2 * margin);
                const lines = doc.splitTextToSize(formData.commentaires, maxWidth);
                
                lines.forEach(line => {
                    if (yPosition > 270) { doc.addPage(); yPosition = margin; }
                    doc.text(line, margin, yPosition);
                    yPosition += 5;
                });
                yPosition += 5;
            }
                
                // Total
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text(`Total estim√© : ${total.toFixed(2).replace('.', ',')} $`, pageWidth - margin, yPosition, { align: 'right' });
                
                resolve(doc);
            });
        }

        // Utilitaires de validation et d'affichage d'erreur
        function showFormError(message, firstMissingEl) {
            const errorDiv = document.getElementById('form-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            if (firstMissingEl) {
                firstMissingEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                try { firstMissingEl.focus({ preventScroll: true }); } catch(_) { firstMissingEl.focus(); }
            }
        }

        function hideFormError() {
            const errorDiv = document.getElementById('form-error');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        function validateRequiredFields(actionLabel) {
            const intervenantEl = document.getElementById('nomIntervenant');
            const clientEl = document.getElementById('client');
            const intervenant = (intervenantEl.value || '').trim();
            const client = (clientEl.value || '').trim();

            intervenantEl.classList.toggle('input-error', !intervenant);
            clientEl.classList.toggle('input-error', !client);

            if (!intervenant || !client) {
                const firstMissing = !intervenant ? intervenantEl : clientEl;
                showFormError(`Veuillez remplir les champs "Intervenant" et "Client" pour ${actionLabel}.`, firstMissing);
                return false;
            }
            hideFormError();
            return true;
        }

        // Notifications discr√®tes
        function showNotice(type, message) {
            const el = document.getElementById('page-notice');
            if (!el) return;
            el.className = `notice ${type}`;
            el.textContent = message;
            el.style.display = 'block';
            // Auto-hide apr√®s 6s pour info uniquement
            if (type === 'info') {
                clearTimeout(showNotice._t);
                showNotice._t = setTimeout(() => { el.style.display = 'none'; }, 6000);
            }
        }

        // (panneau d'√©dition retir√©)

        async function sendRequisitionEmail() {
            if (!validateRequiredFields('envoyer par courriel')) return;
            const intervenant = document.getElementById('nomIntervenant').value;
            const client = document.getElementById('client').value;
            
            try {
                // G√©n√©rer le PDF
                const doc = await generatePDF();
                const pdfData = doc.output('datauristring');
                
                const poste = document.getElementById('poste').value;
                const intervenantPart = poste ? `${intervenant} (#${poste})` : intervenant;
                const subject = `R√©quisition de mat√©riel pour ${client} par ${intervenantPart}`;
                
                // Corps de l'email avec instructions actualis√©es pour la pi√®ce jointe
                const body = `Bonjour,

Veuillez trouver ci-joint la r√©quisition de mat√©riel pour :
- Client: ${client}
- Intervenant: ${intervenantPart}
- Date: ${document.getElementById('date').value}

Note : Le PDF a √©t√© g√©n√©r√© automatiquement mais ne peut pas √™tre joint automatiquement, veuillez le joindre au courriel manuellement.

Cordialement,
${intervenant}`;

                // T√©l√©charger le PDF d'abord
                const currentDate = new Date().toISOString().slice(0, 10);
                const filename = `Requisition_${client.replace(/[^a-zA-Z0-9]/g, '_')}_${currentDate}.pdf`;
                doc.save(filename);
                
                // Sauvegarder dans l'historique avant envoi
                saveToHistory('envoy√©e');
                
                // Ouvrir le client email pr√©-rempli et afficher une notification discr√®te
                const email = 'agentesadsherbrooke.csss-iugs@ssss.gouv.qc.ca';
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                setTimeout(() => { window.location.href = mailtoLink; }, 300);
                showNotice('info', `PDF t√©l√©charg√© sous ¬´ ${filename} ¬ª. Joignez-le manuellement √† votre courriel.`);
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                // Fallback: ouvrir directement le client email avec le texte brut
                const body = generateRequisitionText();
                
                // Sauvegarder dans l'historique m√™me en cas d'erreur PDF
                saveToHistory('envoy√©e');
                
                const email = 'agentesadsherbrooke.csss-iugs@ssss.gouv.qc.ca';
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
                showNotice('warn', "Impossible de g√©n√©rer le PDF automatiquement. Le courriel s'ouvrira sans pi√®ce jointe.");
            }
        }
        
        async function openOutlookWeb() {
            if (!validateRequiredFields('utiliser Outlook Web')) return;
            
            const intervenant = document.getElementById('nomIntervenant').value;
            const client = document.getElementById('client').value;
            const poste = document.getElementById('poste').value;
            
            const intervenantPart = poste ? `${intervenant} (#${poste})` : intervenant;
            const subject = `R√©quisition de mat√©riel pour ${client} par ${intervenantPart}`;
            
            try {
                // G√©n√©rer le PDF
                const doc = await generatePDF();
                const pdfData = doc.output('datauristring');
                
                // T√©l√©charger le PDF automatiquement
                const currentDate = new Date().toISOString().slice(0, 10);
                const filename = `Requisition_${client.replace(/[^a-zA-Z0-9]/g, '_')}_${currentDate}.pdf`;
                doc.save(filename);
                
                // Corps de l'email avec instructions pour Outlook Web
                const body = `Bonjour,

Veuillez trouver ci-joint la r√©quisition de mat√©riel pour :
- Client: ${client}
- Intervenant: ${intervenantPart}
- Date: ${document.getElementById('date').value}

Le fichier PDF "${filename}" a √©t√© t√©l√©charg√© automatiquement dans votre dossier de t√©l√©chargements. 
Veuillez le joindre manuellement √† ce courriel avant l'envoi.

Cordialement,
${intervenant}`;
                
                const email = 'agentesadsherbrooke.csss-iugs@ssss.gouv.qc.ca';
                
                // Tentative exp√©rimentale : copier le nom du fichier dans le presse-papiers pour faciliter la recherche
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(filename);
                        console.log('Nom de fichier copi√© dans le presse-papiers');
                    } catch (clipboardError) {
                        console.log('Impossible de copier dans le presse-papiers:', clipboardError);
                    }
                }
                
                // Cr√©er l'URL Outlook Web
                const outlookWebUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(email)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Sauvegarder dans l'historique avant d'ouvrir
                saveToHistory('envoy√©e');
                
                // D√©lai court pour permettre le t√©l√©chargement, puis ouvrir Outlook Web
                setTimeout(() => {
                    window.open(outlookWebUrl, '_blank');
                }, 500);
                
                // Notification avec instructions d√©taill√©es
                showNotice('info', `PDF g√©n√©r√© : "${filename}". Outlook Web s'ouvrira dans un instant. Le nom du fichier a √©t√© copi√© dans le presse-papiers pour faciliter la recherche lors de l'ajout de la pi√®ce jointe.`);
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                
                // Fallback: ouvrir Outlook Web sans PDF
                const body = `Bonjour,

R√©quisition de mat√©riel pour :
- Client: ${client}
- Intervenant: ${intervenantPart}
- Date: ${document.getElementById('date').value}

Note : Une erreur est survenue lors de la g√©n√©ration automatique du PDF. 
Veuillez utiliser le bouton "Imprimer" pour cr√©er le document manuellement.

Cordialement,
${intervenant}`;
                
                const email = 'agentesadsherbrooke.csss-iugs@ssss.gouv.qc.ca';
                const outlookWebUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(email)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Sauvegarder dans l'historique
                saveToHistory('envoy√©e');
                
                window.open(outlookWebUrl, '_blank');
                showNotice('warn', 'Outlook Web ouvert. Erreur PDF - utilisez le bouton "Imprimer" pour cr√©er le document.');
            }
        }

        function prepareAndPrint() {
            // Validation discr√®te avant impression
            if (!validateRequiredFields('imprimer')) return;

            const categories = document.querySelectorAll('.category');
            const selectedItems = document.querySelectorAll('.item.selected');
            const rootEl = document.documentElement;
            const inventorySection = document.querySelector('.inventory-section');

            // === CORRECTION BUG: Nettoyer les s√©lections orphelines ===
            // S'assurer qu'aucun article coch√© n'est dans une cat√©gorie qui sera masqu√©e
            categories.forEach(cat => {
                const hasSelected = cat.querySelector('.item.selected');
                if (!hasSelected) {
                    // D√©cocher tous les items potentiellement cach√©s de cette cat√©gorie
                    cat.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        const item = cb.closest('.item');
                        if (!item.classList.contains('selected')) {
                            console.log('[BUG FIX] Nettoyage: d√©sactivation de checkbox orpheline dans', cat.querySelector('h3')?.textContent);
                            cb.checked = false;
                        }
                    });
                }
            });
            // === FIN CORRECTION ===

            categories.forEach(cat => {
                cat.classList.toggle('hide-on-print', !cat.querySelector('.item.selected'));
            });
            
            // G√©rer aussi la section des articles hors liste
            const customSection = document.getElementById('customItemsSection');
            if (customSection) {
                const hasSelectedCustom = customSection.querySelector('.item.selected');
                customSection.classList.toggle('hide-on-print', !hasSelectedCustom);
                
                // Pr√©parer les articles hors liste pour l'impression
                customSection.querySelectorAll('.item.selected').forEach(itemEl => {
                    const qtyInput = itemEl.querySelector('.item-qty');
                    const qty = parseInt(qtyInput.value) || 0;
                    itemEl.setAttribute('data-print-qty', qty);
                    
                    // Ajouter le texte de description pour l'impression
                    const descInput = itemEl.querySelector('.custom-desc-input');
                    const nameSpan = itemEl.querySelector('.item-name');
                    if (descInput && nameSpan && descInput.value.trim()) {
                        // Supprimer tout ancien span print-special-value
                        nameSpan.querySelectorAll('.print-special-value').forEach(span => span.remove());
                        
                        const printSpan = document.createElement('span');
                        printSpan.className = 'print-special-value';
                        printSpan.textContent = descInput.value.trim();
                        printSpan.style.display = 'none';
                        nameSpan.appendChild(printSpan);
                    }
                });
            }

            // G√©rer la section commentaires pour l'impression
            const commentsSection = document.getElementById('comments-section');
            const commentsTextarea = document.getElementById('commentaires');
            if (commentsSection && commentsTextarea) {
                const hasComments = commentsTextarea.value.trim().length > 0;
                if (hasComments) {
                    commentsSection.classList.remove('comments-empty-print');
                } else {
                    commentsSection.classList.add('comments-empty-print');
                }
            }

            rootEl.classList.remove('print-condensed', 'print-multicolumn');
            
            // === AM√âLIORATION : Logique adaptative plus intelligente ===
            // Compter le nombre de cat√©gories avec articles s√©lectionn√©s
            const categoriesWithItems = Array.from(categories).filter(cat => 
                cat.querySelector('.item.selected') && !cat.classList.contains('hide-on-print')
            ).length;
            
            // Ajuster selon le nombre d'articles ET de cat√©gories
            if (selectedItems.length > 40 || categoriesWithItems > 6) {
                // Beaucoup d'articles OU beaucoup de cat√©gories
                rootEl.classList.add('print-condensed');
                rootEl.classList.add('print-multicolumn');
                console.log('[PRINT] Mode: Condens√© + Multi-colonnes');
            } else if (selectedItems.length > 25 || categoriesWithItems > 4) {
                // Quantit√© moyenne
                rootEl.classList.add('print-multicolumn');
                console.log('[PRINT] Mode: Multi-colonnes');
            } else if (selectedItems.length > 12 || categoriesWithItems > 3) {
                // Peu d'articles mais risque de d√©bordement
                rootEl.classList.add('print-condensed');
                console.log('[PRINT] Mode: Condens√© (pr√©vention d√©bordement)');
            } else {
                console.log('[PRINT] Mode: Normal');
            }
            // === FIN AM√âLIORATION ===

            let total = 0;
            let printedItemsCount = 0; // === CORRECTION BUG: Compteur d'articles r√©ellement imprim√©s ===
            
            selectedItems.forEach(itemEl => {
                // === CORRECTION BUG: V√©rifier si la cat√©gorie parente sera affich√©e ===
                const parentCategory = itemEl.closest('.category');
                const isCustomItem = itemEl.closest('#customItemsSection');
                
                // Skip si la cat√©gorie est masqu√©e (mais pas pour les articles hors liste)
                if (parentCategory && parentCategory.classList.contains('hide-on-print') && !isCustomItem) {
                    console.warn('[BUG FIX] Article ignor√© lors du calcul car sa cat√©gorie est masqu√©e:', 
                                 itemEl.querySelector('.item-name')?.textContent);
                    return; // Ne pas compter cet article dans le total
                }
                // === FIN CORRECTION ===
                
                printedItemsCount++; // === CORRECTION BUG: Compter seulement les articles qui seront imprim√©s ===
                
                const qtyInput = itemEl.querySelector('.item-qty');
                const qty = parseInt(qtyInput.value) || 0;
                const itemId = itemEl.getAttribute('data-id');
                
                itemEl.setAttribute('data-print-qty', qty);

                // Calculer le prix total pour cet article
                const priceElement = itemEl.querySelector('.item-price');
                const unitToggle = itemEl.querySelector('[id^="unit-toggle-"]');
                
                if (priceElement) {
                    const boxPrice = priceElement.getAttribute('data-box-price');
                    const unitPrice = priceElement.getAttribute('data-unit-price');
                    
                    let basePrice = boxPrice; // Prix de bo√Æte par d√©faut
                    
                    // V√©rifier si on est en mode unit√©
                    if (unitToggle && unitToggle.checked && unitPrice && unitPrice !== '') {
                        basePrice = unitPrice;
                        const nameSpan = itemEl.querySelector('.item-name');
                        if (nameSpan) {
                            // Supprimer tout ancien span
                            nameSpan.querySelectorAll('.print-special-value, .print-unit-name').forEach(span => span.remove());
                            
                            // Stocker le nom original et cr√©er un nom pour l'impression en mode unit√©
                            const originalText = nameSpan.textContent;
                            let unitText;
                            if (originalText.includes('Bo√Æte de')) {
                                unitText = originalText.replace('Bo√Æte de ', '') + ' (√† l\'unit√©)';
                            } else if (originalText.includes('Paquet de')) {
                                unitText = originalText.replace('Paquet de ', '') + ' (√† l\'unit√©)';
                            } else {
                                unitText = originalText + ' (√† l\'unit√©)';
                            }
                            
                            // Masquer le texte original et ajouter le texte pour mode unit√©
                            nameSpan.style.display = 'none';
                            
                            const unitNameSpan = document.createElement('span');
                            unitNameSpan.className = 'print-unit-name print-only';
                            unitNameSpan.textContent = unitText;
                            unitNameSpan.style.display = 'none';
                            
                            nameSpan.parentElement.insertBefore(unitNameSpan, nameSpan);
                        }
                    }
                    
                    // Calculer le total pour cet article
                    if (basePrice && basePrice !== '-') {
                        const priceValue = parseFloat(basePrice.replace('$', '').trim().replace(',', '.'));
                        if (!isNaN(priceValue)) {
                            total += priceValue * qty;
                        }
                    }
                }
                
                // G√©rer les inputs sp√©ciaux standards
                itemEl.querySelectorAll('.special-input').forEach(input => {
                    if (input.value) {
                        let printValue = input.value;
                        const id = input.id;
                        if (id.startsWith('gauge-')) printValue += ' G';
                        else if (id.startsWith('filet-len-') || id.startsWith('tubi-len-')) printValue += ' cm';
                        else if (id.startsWith('french-')) printValue += ' Fr';
                        else if (id.startsWith('tubifast-len-')) printValue += ' cm';
                        else if (id.startsWith('volume-')) printValue += ' ml';
                        
                        const printSpan = document.createElement('span');
                        printSpan.className = 'print-special-value';
                        printSpan.textContent = printValue;
                        input.parentElement.insertBefore(printSpan, input.nextSibling);
                    }
                });
                
                // G√©rer les couleurs Tubifast (afficher les couleurs choisies)
                const tubifastJaune = itemEl.querySelector('[id^="tubifast-jaune-"]');
                const tubifastBleu = itemEl.querySelector('[id^="tubifast-bleu-"]');
                if (tubifastJaune || tubifastBleu) {
                    let colors = [];
                    if (tubifastJaune && tubifastJaune.checked) colors.push('Jaune');
                    if (tubifastBleu && tubifastBleu.checked) colors.push('Bleu');
                    
                    if (colors.length > 0) {
                        const printSpan = document.createElement('span');
                        printSpan.className = 'print-special-value';
                        printSpan.textContent = colors.join(' + ');
                        printSpan.style.display = 'none';
                        
                        const nameSpan = itemEl.querySelector('.item-name');
                        if (nameSpan) {
                            nameSpan.appendChild(printSpan);
                        }
                    }
                }
            });
            
            // D√©place le r√©sum√© √† la fin du contenu de l'inventaire
            const summaryEl = document.getElementById('print-summary');
            if (summaryEl) {
                const currentDate = new Date().toLocaleDateString('fr-CA');
                summaryEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <span style="font-size: 8pt; font-weight: normal;">SAD-PA - ${currentDate}</span>
                        <span>Total estim√© : ${total.toFixed(2).replace('.', ',')} $</span>
                    </div>
                `;
                // Place le total apr√®s le dernier √©l√©ment de l'inventaire
                inventorySection.appendChild(summaryEl);
            }

            // === CORRECTION BUG: Log de d√©bogage pour v√©rifier la coh√©rence ===
            console.log(`[BUG FIX] V√©rification impression:
                - Articles s√©lectionn√©s (total): ${selectedItems.length}
                - Articles qui seront imprim√©s: ${printedItemsCount}
                - Total calcul√©: ${total.toFixed(2)} $`);
            
            if (printedItemsCount !== selectedItems.length) {
                console.warn(`[BUG FIX] ATTENTION: ${selectedItems.length - printedItemsCount} article(s) s√©lectionn√©(s) ne sera/seront pas imprim√©(s)!`);
            }
            // === FIN CORRECTION ===

            // Sauvegarder dans l'historique avant impression
            saveToHistory('imprim√©e');

            window.print();
        }
        
        function cleanupAfterPrint() {
            document.querySelectorAll('.category.hide-on-print').forEach(cat => {
                cat.classList.remove('hide-on-print');
            });
            document.documentElement.classList.remove('print-condensed', 'print-multicolumn');

            document.querySelectorAll('.item.selected').forEach(itemEl => {
                itemEl.removeAttribute('data-print-qty');
            });

            // Nettoyer les valeurs de print-special et remettre les noms originaux
            document.querySelectorAll('.print-special-value, .print-unit-name').forEach(span => span.remove());
            
            // Remettre les noms originaux visibles
            document.querySelectorAll('.item-name[style*="display: none"]').forEach(nameSpan => {
                nameSpan.style.display = '';
            });
            
            // Remet le r√©sum√© √† sa position d'origine
            const summaryEl = document.getElementById('print-summary');
            const container = document.querySelector('.container');
            if (summaryEl && container) {
                summaryEl.innerHTML = '';
                container.appendChild(summaryEl);
            }
            
            // Nettoyer la classe des commentaires vides
            const commentsSection = document.getElementById('comments-section');
            if (commentsSection) {
                commentsSection.classList.remove('comments-empty-print');
            }
        }

        window.addEventListener('afterprint', cleanupAfterPrint);
        
        // Syst√®me de navigation au clavier
        let currentFocusIndex = -1;
        let allItemElements = [];

        function initKeyboardNavigation() {
            allItemElements = Array.from(document.querySelectorAll('.item'));
            
            // Ajouter un attribut data-index pour faciliter la navigation
            allItemElements.forEach((item, index) => {
                item.setAttribute('data-index', index);
                
                // Ajouter le support de la molette de souris sur les champs de quantit√©
                const qtyInput = item.querySelector('.item-qty');
                if (qtyInput) {
                    qtyInput.addEventListener('wheel', handleMouseWheel);
                }
            });

            // √âcouter les √©v√©nements clavier sur tout le document
            document.addEventListener('keydown', handleKeyboardNavigation);
        }

        function handleMouseWheel(e) {
            e.preventDefault();
            
            const item = e.target.closest('.item');
            const checkbox = item.querySelector('input[type="checkbox"]');
            // Articles hors liste (sans checkbox)
            if (!checkbox) {
                const qtyInput = item.querySelector('.item-qty');
                if (!qtyInput) return;
                const delta = e.deltaY < 0 ? 1 : -1;
                const multiplier = e.shiftKey ? 5 : 1;
                const maxQty = parseInt(qtyInput.max) || 20;
                const currentQty = parseInt(qtyInput.value) || 1;
                const newQty = Math.max(1, Math.min(maxQty, currentQty + delta * multiplier));
                qtyInput.value = newQty;
                item.classList.add('selected');
                updateSummary();
                return;
            }
            
            if (!checkbox.checked) {
                return;
            }
            
            const itemId = checkbox.id;
            const delta = e.deltaY < 0 ? 1 : -1;
            
            // Utiliser Shift pour des changements plus rapides
            const multiplier = e.shiftKey ? 5 : 1;
            
            adjustQty(itemId, delta * multiplier);
        }

        function toggleKeyboardHelp() {
            const helpDiv = document.getElementById('keyboard-help');
            helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Variable pour tracker si on est dans le champ commentaires
        let isInCommentsField = false;

        function handleKeyboardNavigation(e) {
            // Ignorer si on est dans un champ de texte, date, ou textarea
            if (e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'date')) {
                return;
            }
            if (e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Ignorer aussi si on est dans le champ de recherche
            if (e.target.id === 'searchInput') {
                return;
            }
            
            // Ignorer compl√®tement si on est dans le champ commentaires
            if (isInCommentsField) {
                return;
            }

            const key = e.key.toLowerCase();
            const code = e.code;

            switch(key) {
                case 'arrowup':
                case 'w':
                    e.preventDefault();
                    navigateItems(-1);
                    break;
                
                case 'arrowdown':
                case 's':
                    e.preventDefault();
                    navigateItems(1);
                    break;
                
                case 'pageup':
                    e.preventDefault();
                    navigateItems(-5);
                    break;
                
                case 'pagedown':
                    e.preventDefault();
                    navigateItems(5);
                    break;
                
                case 'home':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        navigateToIndex(0);
                    }
                    break;
                
                case 'end':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        navigateToIndex(allItemElements.length - 1);
                    }
                    break;
                
                case 'arrowleft':
                case 'a':
                    e.preventDefault();
                    navigateItems(-1);
                    break;
                
                case 'arrowright':
                case 'd':
                    e.preventDefault();
                    navigateItems(1);
                    break;
                
                case ' ':  // Barre d'espace
                    e.preventDefault();
                    toggleCurrentItem();
                    break;
                
                case '5':  // Numpad 5
                    if (code === 'Numpad5') {
                        e.preventDefault();
                        toggleCurrentItem();
                    }
                    break;
                
                case '+':
                case '=':  // Pour le + sans shift
                case 'e':
                    e.preventDefault();
                    adjustCurrentItemQty(1);
                    break;
                
                case '-':
                case '_':  // Pour le - du pav√© num√©rique
                case 'q':
                    e.preventDefault();
                    adjustCurrentItemQty(-1);
                    break;
                
                case 'enter':
                    e.preventDefault();
                    toggleCurrentItem();
                    break;
                
                case 'escape':
                    e.preventDefault();
                    clearFocus();
                    break;
            }
        }

        function navigateItems(direction) {
            // S'assurer que les √©l√©ments sont initialis√©s
            if (allItemElements.length === 0) {
                allItemElements = Array.from(document.querySelectorAll('.item'));
            }
            
            // Retirer le focus actuel
            if (currentFocusIndex >= 0 && currentFocusIndex < allItemElements.length) {
                allItemElements[currentFocusIndex].classList.remove('focused');
            }

            // Calculer le nouvel index
            currentFocusIndex += direction;

            // G√©rer les limites
            if (currentFocusIndex < 0) {
                currentFocusIndex = allItemElements.length - 1;
            } else if (currentFocusIndex >= allItemElements.length) {
                currentFocusIndex = 0;
            }

            // Appliquer le nouveau focus
            const focusedItem = allItemElements[currentFocusIndex];
            if (focusedItem) {
                focusedItem.classList.add('focused');
                
                // Scrolling am√©lior√© avec centrage
                const rect = focusedItem.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const scrollPadding = viewportHeight * 0.3; // 30% de marge en haut et en bas
                
                // V√©rifier si l'√©l√©ment est proche des bords
                if (rect.top < scrollPadding || rect.bottom > viewportHeight - scrollPadding) {
                    // Centrer l'√©l√©ment dans la fen√™tre
                    const elementTop = focusedItem.offsetTop;
                    const elementHeight = focusedItem.offsetHeight;
                    const targetScrollY = elementTop - (viewportHeight / 2) + (elementHeight / 2);
                    
                    window.scrollTo({
                        top: targetScrollY,
                        behavior: 'smooth'
                    });
                }
            }
        }

        function toggleCurrentItem() {
            if (currentFocusIndex < 0 || currentFocusIndex >= allItemElements.length) {
                return;
            }

            const item = allItemElements[currentFocusIndex];
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleItem(checkbox);
            } else {
                // Rien √† basculer pour les articles hors liste
            }
        }

        function adjustCurrentItemQty(change) {
            // S'assurer que les √©l√©ments sont initialis√©s
            if (allItemElements.length === 0) {
                allItemElements = Array.from(document.querySelectorAll('.item'));
            }
            
            // Si aucun √©l√©ment n'est focalis√©, focalis√© le premier
            if (currentFocusIndex < 0 && allItemElements.length > 0) {
                currentFocusIndex = 0;
                allItemElements[0].classList.add('focused');
            }
            
            if (currentFocusIndex < 0 || currentFocusIndex >= allItemElements.length) {
                return;
            }

            const item = allItemElements[currentFocusIndex];
            const checkbox = item.querySelector('input[type="checkbox"]');
            // Si pas de checkbox (articles hors liste), ajuster directement
            if (!checkbox) {
                const qtyInput = item.querySelector('.item-qty');
                if (qtyInput) {
                    const maxQty = parseInt(qtyInput.max) || 20;
                    const currentQty = parseInt(qtyInput.value) || 1;
                    const newQty = Math.max(1, Math.min(maxQty, currentQty + change));
                    qtyInput.value = newQty;
                    item.classList.add('selected');
                    updateSummary();
                }
                return;
            }

            // Si l'article n'est pas s√©lectionn√© et qu'on augmente la quantit√©, le s√©lectionner d'abord
            if (!checkbox.checked && change > 0) {
                checkbox.checked = true;
                toggleItem(checkbox);
            }
            
            if (checkbox.checked) {
                const itemId = checkbox.id;
                adjustQty(itemId, change);
            }
        }

        function clearFocus() {
            if (currentFocusIndex >= 0 && currentFocusIndex < allItemElements.length) {
                allItemElements[currentFocusIndex].classList.remove('focused');
            }
            currentFocusIndex = -1;
        }
        
        function navigateToIndex(index) {
            // S'assurer que les √©l√©ments sont initialis√©s
            if (allItemElements.length === 0) {
                allItemElements = Array.from(document.querySelectorAll('.item'));
            }
            
            // Retirer le focus actuel
            if (currentFocusIndex >= 0 && currentFocusIndex < allItemElements.length) {
                allItemElements[currentFocusIndex].classList.remove('focused');
            }
            
            // Appliquer le nouvel index
            currentFocusIndex = Math.max(0, Math.min(index, allItemElements.length - 1));
            
            const focusedItem = allItemElements[currentFocusIndex];
            if (focusedItem) {
                focusedItem.classList.add('focused');
                
                // Centrer l'√©l√©ment
                const viewportHeight = window.innerHeight;
                const elementTop = focusedItem.offsetTop;
                const elementHeight = focusedItem.offsetHeight;
                const targetScrollY = elementTop - (viewportHeight / 2) + (elementHeight / 2);
                
                window.scrollTo({
                    top: targetScrollY,
                    behavior: 'smooth'
                });
            }
        }

        // Fonctionnalit√© de recherche
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.addEventListener('input', performSearch);
            clearButton.addEventListener('click', clearSearch);
            
            // Raccourci Ctrl+F pour focus sur la recherche
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
        }
        
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const categories = document.querySelectorAll('.category');
            
            if (!searchTerm) {
                // Si la recherche est vide, utiliser clearSearch pour tout r√©initialiser
                clearSearchDisplay();
                return;
            }
            
            categories.forEach(category => {
                // Ignorer la section des articles hors liste pour la recherche
                if (category.id === 'customItemsSection') {
                    return;
                }
                
                const items = category.querySelectorAll('.item');
                let hasVisibleItems = false;
                
                items.forEach(item => {
                    const itemName = item.querySelector('.item-name').textContent.toLowerCase();
                    const categoryTitle = category.querySelector('h3').textContent.toLowerCase();
                    
                    // Recherche dans le nom de l'article et le titre de la cat√©gorie
                    if (itemName.includes(searchTerm) || categoryTitle.includes(searchTerm)) {
                        item.style.display = 'grid';
                        hasVisibleItems = true;
                        // Surligner le terme recherch√©
                        highlightSearchTerm(item, searchTerm);
                    } else {
                        item.style.display = 'none';
                        removeHighlight(item);
                    }
                });
                
                // Cacher la cat√©gorie si aucun article n'est visible
                category.style.display = hasVisibleItems ? 'block' : 'none';
            });
            
            // S'assurer que la section des articles hors liste reste toujours visible
            const customSection = document.getElementById('customItemsSection');
            if (customSection) {
                customSection.style.display = 'block';
            }
            
            // Mettre √† jour les √©l√©ments pour la navigation clavier (exclure les articles hors liste cach√©s)
            allItemElements = Array.from(document.querySelectorAll('.item[style*="grid"], .item:not([style])'));
            currentFocusIndex = -1;
            clearFocus();
        }
        
        function clearSearchDisplay() {
            // Enlever tous les surlignages et afficher tous les √©l√©ments
            const categories = document.querySelectorAll('.category');
            categories.forEach(category => {
                // Ne pas traiter la section des articles hors liste ici
                if (category.id === 'customItemsSection') {
                    // Juste s'assurer qu'elle est visible mais ne pas toucher aux √©l√©ments internes
                    category.style.display = 'block';
                    return;
                }
                
                category.style.display = 'block';
                const items = category.querySelectorAll('.item');
                items.forEach(item => {
                    item.style.display = 'grid';
                    removeHighlight(item);
                });
            });
            
            // Mettre √† jour les √©l√©ments pour la navigation clavier
            allItemElements = Array.from(document.querySelectorAll('.item'));
            currentFocusIndex = -1;
            clearFocus();
        }
        
        function highlightSearchTerm(item, searchTerm) {
            const itemName = item.querySelector('.item-name');
            const originalText = itemName.textContent;
            
            // Enlever les anciens surlignages
            removeHighlight(item);
            
            // Cr√©er le nouveau texte avec surlignage
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            const highlightedText = originalText.replace(regex, '<mark>$1</mark>');
            
            if (highlightedText !== originalText) {
                itemName.innerHTML = highlightedText;
            }
        }
        
        function removeHighlight(item) {
            const itemName = item.querySelector('.item-name');
            const text = itemName.textContent; // Ceci enl√®ve automatiquement les balises HTML
            itemName.textContent = text;
        }
        
        function forceEnsureCustomItemsVisible() {
            // Fonction d√©fensive pour s'assurer que les articles hors liste sont toujours visibles et fonctionnels
            const customSection = document.getElementById('customItemsSection');
            const customList = document.getElementById('customItemsList');
            
            if (!customSection || !customList) {
                console.error('Sections articles hors liste non trouv√©es');
                return;
            }
            
            // Forcer la visibilit√© de la section
            customSection.style.display = 'block';
            customSection.style.visibility = 'visible';
            
            // V√©rifier s'il y a au moins une ligne vide
            const existingRows = customList.querySelectorAll('.item');
            const hasEmptyRow = Array.from(existingRows).some(row => {
                const textInput = row.querySelector('.custom-desc-input');
                return textInput && textInput.value.trim() === '';
            });
            
            // Si pas de ligne vide, en cr√©er une
            if (!hasEmptyRow) {
                const newRow = createCustomItemRow();
                customList.appendChild(newRow);
            }
            
            // S'assurer que tous les champs de texte visibles fonctionnent
            customList.querySelectorAll('.custom-desc-input').forEach(input => {
                input.style.display = 'block';
                input.style.visibility = 'visible';
                input.disabled = false;
            });
        }

        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            clearSearchDisplay();
            
            // Apr√®s avoir nettoy√© la recherche, s'assurer que les articles hors liste sont OK
            setTimeout(() => {
                forceEnsureCustomItemsVisible();
            }, 50);
        }

        // --- Articles hors liste: gestion des lignes dynamiques ---
        const MAX_CUSTOM_ITEMS = 10;
        let customItemCounter = 0;
        
        function createCustomItemRow() {
            customItemCounter++;
            const index = customItemCounter;
            const row = document.createElement('div');
            row.className = 'item';
            row.dataset.type = 'custom';
            row.dataset.customIndex = index;

            row.innerHTML = `
                <input type=\"checkbox\" id=\"custom-check-${index}\" onchange=\"toggleCustomItem(this, ${index})\" style=\"width: 20px; height: 20px; accent-color: #667eea;\">
                <div class=\"qty-controls\">
                    <button class=\"qty-btn decrement\" onclick=\"adjustCustomQty(${index}, -10)\" disabled>-10</button>
                    <button class=\"qty-btn decrement\" onclick=\"adjustCustomQty(${index}, -5)\" disabled>-5</button>
                    <button class=\"qty-btn decrement\" onclick=\"adjustCustomQty(${index}, -1)\" disabled>-1</button>
                    <input type=\"number\" class=\"item-qty\" id=\"custom-qty-${index}\" min=\"1\" max=\"20\" value=\"1\" disabled>
                    <button class=\"qty-btn increment\" onclick=\"adjustCustomQty(${index}, 1)\" disabled>+1</button>
                    <button class=\"qty-btn increment\" onclick=\"adjustCustomQty(${index}, 5)\" disabled>+5</button>
                    <button class=\"qty-btn increment\" onclick=\"adjustCustomQty(${index}, 10)\" disabled>+10</button>
                </div>
                <div class=\"item-details\">
                    <span class=\"item-name\" id=\"custom-name-${index}\">
                        <input type=\"text\" class=\"custom-desc-input\" id=\"custom-desc-${index}\" 
                               placeholder=\"Description de l'article\" 
                               style=\"width: 100%; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;\"
                               oninput=\"onCustomDescInput(${index})\">
                    </span>
                </div>
                <span class=\"item-price\">-</span>`;

            return row;
        }

        function initCustomItems() {
            const list = document.getElementById('customItemsList');
            if (!list) {
                console.error('customItemsList element not found');
                return;
            }
            
            // Nettoyer le contenu existant
            list.innerHTML = '';
            customItemCounter = 0;
            
            // Cr√©er une nouvelle ligne vide
            const newRow = createCustomItemRow();
            list.appendChild(newRow);
            
            // S'assurer que la section parent est visible
            const customSection = document.getElementById('customItemsSection');
            if (customSection) {
                customSection.style.display = 'block';
            }
            
            console.log('Articles hors liste initialis√©s avec succ√®s');
        }
        
        function toggleCustomItem(checkbox, index) {
            const item = checkbox.closest('.item');
            const qtyButtons = item.querySelectorAll('.qty-btn');
            const qtyInput = item.querySelector('.item-qty');
            const descInput = item.querySelector('.custom-desc-input');
            
            if (checkbox.checked) {
                item.classList.add('selected');
                qtyButtons.forEach(btn => btn.disabled = false);
                qtyInput.disabled = false;
                qtyInput.readOnly = false;
                qtyInput.value = 1;
                updateCustomQtyButtons(index);
            } else {
                item.classList.remove('selected');
                qtyButtons.forEach(btn => btn.disabled = true);
                qtyInput.disabled = true;
                qtyInput.readOnly = true;
                qtyInput.value = 0;
            }
            updateSummary();
        }
        
        function updateCustomQtyButtons(index) {
            const item = document.querySelector(`.item[data-custom-index=\"${index}\"]`);
            if (!item) return;
            const qtyInput = item.querySelector('.item-qty');
            const currentQty = parseInt(qtyInput.value);
            const maxQty = 20;
            const buttons = item.querySelectorAll('.qty-btn');
            
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                if (button.style.visibility === 'hidden') return;
                
                if (onclick.includes('-10')) {
                    button.disabled = currentQty <= 10;
                } else if (onclick.includes('-5')) {
                    button.disabled = currentQty <= 5;
                } else if (onclick.includes('-1')) {
                    button.disabled = currentQty <= 1;
                } else if (onclick.includes('1)')) {
                    button.disabled = currentQty >= maxQty;
                } else if (onclick.includes('5)')) {
                    button.disabled = currentQty + 4 >= maxQty;
                } else if (onclick.includes('10)')) {
                    button.disabled = currentQty + 9 >= maxQty;
                }
            });
        }

        function onCustomDescInput(index) {
            const descEl = document.getElementById(`custom-desc-${index}`);
            const checkbox = document.getElementById(`custom-check-${index}`);
            const row = descEl.closest('.item');
            const value = (descEl.value || '').trim();
            const list = document.getElementById('customItemsList');

            if (value) {
                // Activer automatiquement la checkbox si du texte est entr√©
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    toggleCustomItem(checkbox, index);
                }
                
                // Ajouter une nouvelle ligne si c'est la derni√®re et qu'on n'a pas atteint le max
                const rows = Array.from(list.querySelectorAll('.item'));
                const isLast = rows[rows.length - 1] === row;
                if (isLast && rows.length < MAX_CUSTOM_ITEMS) {
                    list.appendChild(createCustomItemRow());
                }
            } else {
                // D√©sactiver la checkbox si le texte est effac√©
                if (checkbox.checked) {
                    checkbox.checked = false;
                    toggleCustomItem(checkbox, index);
                }
                pruneTrailingEmptyCustomRows();
            }
        }

        function pruneTrailingEmptyCustomRows() {
            const list = document.getElementById('customItemsList');
            if (!list) return;
            const rows = Array.from(list.querySelectorAll('.item'));
            let emptyCount = 0;
            for (let i = rows.length - 1; i >= 0; i--) {
                const desc = rows[i].querySelector('.custom-desc-input');
                const val = (desc.value || '').trim();
                if (!val) {
                    emptyCount++;
                    if (emptyCount > 1) rows[i].remove();
                } else {
                    break;
                }
            }
        }

        function getCustomItems() {
            const list = document.getElementById('customItemsList');
            if (!list) return [];
            const rows = Array.from(list.querySelectorAll('.item'));
            return rows.map((row) => {
                const checkbox = row.querySelector('input[type=\"checkbox\"]');
                const desc = row.querySelector('.custom-desc-input');
                const qty = row.querySelector('.item-qty');
                const name = (desc.value || '').trim();
                const q = parseInt(qty.value) || 0;
                return (checkbox && checkbox.checked && name) ? { name, qty: Math.max(1, Math.min(20, q)) } : null;
            }).filter(Boolean);
        }

        function adjustCustomQty(index, delta) {
            const checkbox = document.getElementById(`custom-check-${index}`);
            if (!checkbox || !checkbox.checked) return;
            
            const qtyEl = document.getElementById(`custom-qty-${index}`);
            const descEl = document.getElementById(`custom-desc-${index}`);
            if (!qtyEl || !descEl) return;
            if (!(descEl.value || '').trim()) return;
            
            const max = 20;
            const val = parseInt(qtyEl.value) || 1;
            const next = Math.max(1, Math.min(max, val + delta));
            qtyEl.value = next;
            updateCustomQtyButtons(index);
            updateSummary();
        }

        function resetCustomItems() { 
            customItemCounter = 0;
            initCustomItems(); 
        }
        
        // ================================
        // SYST√àME DE PERSISTANCE LOCALE
        // ================================
        const STORAGE_KEYS = {
            HISTORY: 'requisition_history'
        };

        const MAX_HISTORY_NORMAL = 400;
        const MAX_HISTORY_TOTAL = 500;


        // Fonction pour r√©cup√©rer les articles s√©lectionn√©s (non-custom)
        function getSelectedItems() {
            const selectedElements = document.querySelectorAll('.item.selected:not(#customItemsSection .item)');
            const items = [];
            
            selectedElements.forEach(itemEl => {
                const qtyInput = itemEl.querySelector('.item-qty');
                const priceEl = itemEl.querySelector('.item-price');
                const nameEl = itemEl.querySelector('.item-name');
                
                if (qtyInput && priceEl && nameEl) {
                    const qty = parseInt(qtyInput.value) || 1;
                    const priceText = priceEl.textContent.trim();
                    const price = priceText === '-' ? 0 : parseFloat(priceText.replace('$', '').replace(',', '.')) || 0;
                    const name = nameEl.textContent.trim();
                    
                    if (name) {
                        items.push({ name, qty, price });
                    }
                }
            });
            
            return items;
        }

        // Fonction pour r√©cup√©rer les d√©tails complets des articles s√©lectionn√©s pour l'historique
        function getSelectedItemsForHistory() {
            const selectedElements = document.querySelectorAll('.item.selected:not(#customItemsSection .item)');
            const items = [];
            
            selectedElements.forEach(itemEl => {
                const checkbox = itemEl.querySelector('input[type="checkbox"]');
                if (!checkbox) return;
                
                const itemId = checkbox.id;
                const qtyInput = itemEl.querySelector('.item-qty');
                const priceEl = itemEl.querySelector('.item-price');
                const nameEl = itemEl.querySelector('.item-name');
                
                if (qtyInput && priceEl && nameEl) {
                    const qty = parseInt(qtyInput.value) || 1;
                    const priceText = priceEl.textContent.trim();
                    const price = priceText === '-' ? 0 : parseFloat(priceText.replace('$', '').replace(',', '.')) || 0;
                    const name = nameEl.textContent.trim();
                    
                    // Capturer les inputs sp√©ciaux
                    const specialInputs = {};
                    const specialInputElements = itemEl.querySelectorAll('.special-input');
                    specialInputElements.forEach(input => {
                        if (input.value) {
                            specialInputs[input.id] = input.value;
                        }
                    });
                    
                    // Capturer le mode unit√© si applicable
                    const unitToggle = itemEl.querySelector(`#unit-toggle-${itemId}`);
                    const isUnitMode = unitToggle ? unitToggle.checked : false;
                    
                    // Capturer les checkboxes Tubifast
                    const tubifastJaune = itemEl.querySelector(`#tubifast-jaune-${itemId}`);
                    const tubifastBleu = itemEl.querySelector(`#tubifast-bleu-${itemId}`);
                    const tubifastColors = [];
                    if (tubifastJaune && tubifastJaune.checked) tubifastColors.push('jaune');
                    if (tubifastBleu && tubifastBleu.checked) tubifastColors.push('bleu');
                    
                    if (name) {
                        items.push({ 
                            id: itemId,
                            name, 
                            qty, 
                            price,
                            specialInputs,
                            isUnitMode,
                            tubifastColors,
                            type: 'standard'
                        });
                    }
                }
            });
            
            return items;
        }

        // Fonction pour r√©cup√©rer les articles hors liste avec d√©tails complets
        function getCustomItemsForHistory() {
            const list = document.getElementById('customItemsList');
            if (!list) return [];
            
            const rows = Array.from(list.querySelectorAll('.item'));
            return rows.map((row, index) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const desc = row.querySelector('.custom-desc-input');
                const qty = row.querySelector('.item-qty');
                const name = (desc.value || '').trim();
                const q = parseInt(qty.value) || 0;
                
                if (checkbox && checkbox.checked && name) {
                    return { 
                        name, 
                        qty: Math.max(1, Math.min(20, q)),
                        price: 0, // Articles hors liste n'ont pas de prix
                        type: 'custom',
                        index: index
                    };
                }
                return null;
            }).filter(Boolean);
        }

        // Sauvegarde d'une requ√™te dans l'historique
        function saveToHistory(status) {
            console.log('=== DEBUT saveToHistory ===', status);
            
            try {
                // R√©cup√©rer les donn√©es du formulaire directement
                const client = document.getElementById('client').value.trim() || 'Client non sp√©cifi√©';
                const intervenant = document.getElementById('nomIntervenant').value.trim() || 'Intervenant non sp√©cifi√©';
                
                console.log('Donn√©es formulaire:', { client, intervenant });
                
                // R√©cup√©rer les articles avec gestion d'erreurs
                let selectedItems = [];
                let customItemsForDisplay = [];
                let customItemsForHistory = [];
                
                try {
                    selectedItems = getSelectedItemsForHistory();
                    console.log('Articles standards r√©cup√©r√©s:', selectedItems.length);
                } catch (e) {
                    console.warn('Erreur lors de la r√©cup√©ration des articles standards:', e);
                    // Fallback vers la fonction simple mais convertir le format
                    const simpleItems = getSelectedItems();
                    selectedItems = simpleItems.map(item => ({
                        id: '', // Pas d'ID disponible dans la version simple
                        name: item.name,
                        qty: item.qty,
                        price: item.price,
                        specialInputs: {},
                        isUnitMode: false,
                        tubifastColors: [],
                        type: 'standard'
                    }));
                }
                
                try {
                    customItemsForDisplay = getCustomItems(); // Pour le calcul du total et r√©sum√©
                    customItemsForHistory = getCustomItemsForHistory();
                    console.log('Articles hors liste r√©cup√©r√©s:', customItemsForHistory.length);
                } catch (e) {
                    console.warn('Erreur lors de la r√©cup√©ration des articles hors liste:', e);
                    customItemsForDisplay = [];
                    customItemsForHistory = [];
                }
                
                const allSelected = [...selectedItems, ...customItemsForDisplay];
                
                console.log('Articles r√©cup√©r√©s pour sauvegarde:', { 
                    client, 
                    intervenant, 
                    selectedCount: selectedItems.length, 
                    customDisplayCount: customItemsForDisplay.length,
                    customHistoryCount: customItemsForHistory.length,
                    totalItems: allSelected.length,
                    status 
                });
                
                if (allSelected.length === 0) {
                    console.log('Aucun article s√©lectionn√©, pas de sauvegarde');
                    return; // Pas d'articles s√©lectionn√©s
                }
                
                console.log('Sauvegarde en cours...', {
                    totalArticles: allSelected.length,
                    standardItems: selectedItems.length,
                    customItems: customItemsForHistory.length
                });
                
                const totalCost = allSelected.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const topItems = allSelected
                    .sort((a, b) => (b.price * b.qty) - (a.price * a.qty))
                    .slice(0, 3)
                    .map(item => item.name)
                    .join(', ');
                
                const historyEntry = {
                    id: Date.now(),
                    date: document.getElementById('date').value || new Date().toLocaleDateString('fr-CA'),
                    client: client,
                    intervenant: intervenant,
                    status: status, // 'imprim√©e' ou 'envoy√©e'
                    itemsCount: allSelected.length,
                    totalCost: totalCost,
                    summary: topItems,
                    pinned: false,
                    timestamp: new Date().toISOString(),
                    // Nouveaux champs pour la restauration
                    standardItems: selectedItems,
                    customItems: customItemsForHistory,
                    formData: {
                        client: client,
                        intervenant: intervenant,
                        poste: document.getElementById('poste').value.trim() || '',
                        date: document.getElementById('date').value,
                        commentaires: document.getElementById('commentaires').value.trim() || ''
                    }
                };
                
                let history = getHistory();
                history.unshift(historyEntry); // Ajouter en premi√®re position
                
                // G√©rer la rotation (garder les √©pingl√©es, limiter les normales)
                const pinned = history.filter(item => item.pinned);
                const normal = history.filter(item => !item.pinned);
                
                // Limiter les requ√™tes normales
                if (normal.length > MAX_HISTORY_NORMAL) {
                    normal.splice(MAX_HISTORY_NORMAL);
                }
                
                // Recombiner et limiter le total
                const finalHistory = [...pinned, ...normal];
                if (finalHistory.length > MAX_HISTORY_TOTAL) {
                    // Supprimer les plus anciennes non-√©pingl√©es
                    const toRemove = finalHistory.length - MAX_HISTORY_TOTAL;
                    for (let i = finalHistory.length - 1; i >= 0 && toRemove > 0; i--) {
                        if (!finalHistory[i].pinned) {
                            finalHistory.splice(i, 1);
                        }
                    }
                }
                
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(finalHistory));
                
                console.log(`‚úÖ Requ√™te sauvegard√©e dans l'historique: ${client} (${status})`);
                console.log('=== FIN saveToHistory SUCC√àS ===');
                
            } catch (e) {
                console.error('‚ùå Erreur lors de la sauvegarde de l\'historique:', e);
                console.log('=== FIN saveToHistory ERREUR ===');
            }
        }

        // R√©cup√©ration de l'historique
        function getHistory() {
            try {
                const stored = localStorage.getItem(STORAGE_KEYS.HISTORY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.warn('Erreur lors du chargement de l\'historique:', e);
                return [];
            }
        }

        // Basculer le statut √©pingl√© d'une requ√™te
        function togglePinned(id) {
            try {
                const history = getHistory();
                const entry = history.find(item => item.id === id);
                if (entry) {
                    entry.pinned = !entry.pinned;
                    localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
                    renderHistory(); // Rafra√Æchir l'affichage
                }
            } catch (e) {
                console.warn('Erreur lors du basculement de l\'√©pingle:', e);
            }
        }

        // ================================
        // INTERFACE D'HISTORIQUE
        // ================================
        
        // Afficher la modal d'historique
        function showHistory() {
            const modal = document.getElementById('history-modal');
            modal.style.display = 'flex';
            renderHistory();
            
            // Fermer avec Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeHistory();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Fermer la modal d'historique
        function closeHistory() {
            const modal = document.getElementById('history-modal');
            modal.style.display = 'none';
        }

        // Rendre l'historique dans la modal
        function renderHistory() {
            const history = getHistory();
            const statsEl = document.getElementById('history-stats');
            const listEl = document.getElementById('history-list');
            
            // Statistiques
            const pinned = history.filter(item => item.pinned);
            const normal = history.filter(item => !item.pinned);
            
            statsEl.innerHTML = `
                <div><strong>${pinned.length}</strong> requ√™tes importantes</div>
                <div><strong>${normal.length}</strong> requ√™tes r√©centes</div>
                <div><strong>${history.length}</strong> total</div>
            `;
            
            // Liste des requ√™tes (√©pingl√©es d'abord)
            if (history.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Aucune requ√™te dans l\'historique</p>';
                return;
            }
            
            const sortedHistory = [...pinned, ...normal];
            
            listEl.innerHTML = sortedHistory.map(entry => `
                <div class="history-item ${entry.pinned ? 'pinned' : ''}">
                    <div class="history-header">
                        <div class="history-client">${entry.client || 'Client non sp√©cifi√©'}</div>
                        <div class="history-actions">
                            <span class="history-status ${entry.status}">${entry.status}</span>
                            <button class="restore-button" 
                                    onclick="restoreFromHistory(${entry.id})" 
                                    title="Restaurer cette requ√™te">
                                üîÑ Restaurer
                            </button>
                            <button class="pin-button ${entry.pinned ? 'pinned' : ''}" 
                                    onclick="togglePinned(${entry.id})" 
                                    title="${entry.pinned ? 'Retirer l\'√©pingle' : '√âpingler cette requ√™te'}">
                                ${entry.pinned ? 'üìå' : 'üìç'}
                            </button>
                        </div>
                    </div>
                    <div class="history-info">
                        <div><strong>Date:</strong> ${entry.date}</div>
                        <div><strong>Intervenant:</strong> ${entry.intervenant || 'N/A'}</div>
                        <div><strong>Articles:</strong> ${entry.itemsCount}</div>
                        <div><strong>Total:</strong> ${entry.totalCost.toFixed(2)}$</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #888;">
                        <strong>Articles:</strong> ${entry.summary || 'Aucun d√©tail'}
                    </div>
                </div>
            `).join('');
        }

        // Effacer tout l'historique
        function clearAllHistory() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique ? Cette action est irr√©versible.')) {
                localStorage.removeItem(STORAGE_KEYS.HISTORY);
                renderHistory();
                showNotice('info', 'Historique effac√© avec succ√®s.');
            }
        }

        // Restaurer une requ√™te de l'historique
        function restoreFromHistory(entryId) {
            try {
                const history = getHistory();
                const entry = history.find(item => item.id === entryId);
                
                if (!entry) {
                    showNotice('error', 'Requ√™te introuvable dans l\'historique.');
                    return;
                }
                
                console.log('Donn√©es de l\'entr√©e √† restaurer:', entry);
                
                // V√©rifier si l'entr√©e a les nouvelles donn√©es d√©taill√©es
                if (!entry.standardItems && !entry.customItems) {
                    showNotice('warn', 'Cette requ√™te a √©t√© sauvegard√©e avant la mise √† jour de la restauration. Seules les informations de base peuvent √™tre restaur√©es.');
                    
                    // Restauration basique pour les anciennes entr√©es
                    const confirmation = confirm(`Restaurer les informations de base pour "${entry.client}" du ${entry.date}?\n\n(Client et informations g√©n√©rales seulement)`);
                    if (!confirmation) return;
                    
                    document.getElementById('client').value = entry.client || '';
                    showNotice('info', 'Informations de base restaur√©es. Les articles ne peuvent pas √™tre restaur√©s pour cette ancienne requ√™te.');
                    closeHistory();
                    return;
                }
                
                // Demander confirmation pour restauration compl√®te
                const confirmation = confirm(`Restaurer la requ√™te pour "${entry.client}" du ${entry.date}?\n\nCela va effacer la s√©lection actuelle et la remplacer par celle de l'historique.`);
                if (!confirmation) return;
                
                // Demander si l'utilisateur veut reporter la requ√™te √† la date d'aujourd'hui
                const todayDate = new Date().toLocaleDateString('fr-CA');
                let useToday = false;
                if (entry.formData?.date && entry.formData.date !== todayDate) {
                    useToday = confirm(`Voulez-vous reporter cette requ√™te √† la date d'aujourd'hui (${todayDate})?\n\nDate originale: ${entry.formData.date}\nDate d'aujourd'hui: ${todayDate}\n\nCliquez "OK" pour utiliser la date d'aujourd'hui, "Annuler" pour garder la date originale.`);
                }
                
                console.log('Restauration compl√®te de la requ√™te:', entry);
                
                // 1. Effacer toute s√©lection actuelle
                clearAll();
                
                // 2. Restaurer les donn√©es du formulaire
                if (entry.formData) {
                    document.getElementById('client').value = entry.formData.client || '';
                    document.getElementById('nomIntervenant').value = entry.formData.intervenant || '';
                    document.getElementById('poste').value = entry.formData.poste || '';
                    document.getElementById('commentaires').value = entry.formData.commentaires || '';
                    if (entry.formData.date) {
                        document.getElementById('date').value = useToday ? todayDate : entry.formData.date;
                    }
                }
                
                // 3. Restaurer les articles standards
                if (entry.standardItems && entry.standardItems.length > 0) {
                    console.log('Restauration des articles standards:', entry.standardItems);
                    
                    entry.standardItems.forEach((item, index) => {
                        console.log(`Restauration article ${index + 1}:`, item);
                        
                        const checkbox = document.getElementById(item.id);
                        if (checkbox) {
                            console.log(`Checkbox trouv√© pour ${item.id}`);
                            
                            // Activer l'article
                            checkbox.checked = true;
                            toggleItem(checkbox);
                            
                            // Attendre un peu pour que l'activation se termine
                            setTimeout(() => {
                                // Restaurer la quantit√©
                                const qtyInput = checkbox.closest('.item').querySelector('.item-qty');
                                if (qtyInput) {
                                    console.log(`D√©finition quantit√© ${item.qty} pour ${item.id}`);
                                    qtyInput.value = item.qty;
                                    updateItemPrice(item.id);
                                }
                                
                                // Restaurer le mode unit√© si applicable
                                if (item.isUnitMode) {
                                    const unitToggle = document.getElementById(`unit-toggle-${item.id}`);
                                    if (unitToggle && !unitToggle.checked) {
                                        console.log(`Activation mode unit√© pour ${item.id}`);
                                        unitToggle.checked = true;
                                        unitToggle.dispatchEvent(new Event('change'));
                                    }
                                }
                                
                                // Restaurer les inputs sp√©ciaux
                                if (item.specialInputs && Object.keys(item.specialInputs).length > 0) {
                                    console.log(`Restauration inputs sp√©ciaux pour ${item.id}:`, item.specialInputs);
                                    Object.keys(item.specialInputs).forEach(inputId => {
                                        const input = document.getElementById(inputId);
                                        if (input) {
                                            input.value = item.specialInputs[inputId];
                                            console.log(`Input ${inputId} = ${item.specialInputs[inputId]}`);
                                        } else {
                                            console.warn(`Input ${inputId} non trouv√©`);
                                        }
                                    });
                                }
                                
                                // Restaurer les couleurs Tubifast
                                if (item.tubifastColors && item.tubifastColors.length > 0) {
                                    console.log(`Restauration couleurs Tubifast pour ${item.id}:`, item.tubifastColors);
                                    item.tubifastColors.forEach(color => {
                                        const colorCheckbox = document.getElementById(`tubifast-${color}-${item.id}`);
                                        if (colorCheckbox) {
                                            colorCheckbox.checked = true;
                                            console.log(`Couleur ${color} activ√©e pour ${item.id}`);
                                        }
                                    });
                                }
                            }, 50); // D√©lai pour laisser le temps √† l'activation
                            
                        } else {
                            console.warn(`Checkbox non trouv√© pour l'ID: ${item.id}`);
                        }
                    });
                } else {
                    console.log('Aucun article standard √† restaurer');
                }
                
                // 4. Restaurer les articles hors liste
                if (entry.customItems && entry.customItems.length > 0) {
                    console.log('Restauration des articles hors liste:', entry.customItems);
                    
                    // Attendre un peu pour la restauration des articles hors liste
                    setTimeout(() => {
                        entry.customItems.forEach((customItem, index) => {
                            console.log(`Restauration article hors liste ${index + 1}:`, customItem);
                            
                            // Trouver ou cr√©er la ligne correspondante
                            const list = document.getElementById('customItemsList');
                            if (!list) {
                                console.error('Liste des articles hors liste non trouv√©e');
                                return;
                            }
                            
                            let existingRows = list.querySelectorAll('.item');
                            
                            // Cr√©er des lignes suppl√©mentaires si n√©cessaire
                            while (existingRows.length <= index) {
                                // Utiliser la m√©thode existante ou cr√©er manuellement
                                try {
                                    if (typeof createCustomItemRow === 'function') {
                                        list.appendChild(createCustomItemRow());
                                    } else {
                                        // Cr√©er manuellement la ligne
                                        const newRow = document.createElement('div');
                                        newRow.className = 'item';
                                        newRow.innerHTML = `
                                            <input type="checkbox" id="custom-check-${customItemCounter}" onchange="toggleCustomItem(this, ${customItemCounter})">
                                            <div class="item-details">
                                                <input type="text" class="custom-desc-input" id="custom-desc-${customItemCounter}" 
                                                       placeholder="Description de l'article..." 
                                                       oninput="onCustomDescInput(${customItemCounter})">
                                            </div>
                                            <span class="item-max">Max 20</span>
                                            <div class="qty-controls" style="display: none;">
                                                <button class="qty-btn decrement" onclick="adjustCustomQty(${customItemCounter}, -1)" disabled>-1</button>
                                                <input type="number" class="item-qty" id="custom-qty-${customItemCounter}" min="1" max="20" value="1" disabled>
                                                <button class="qty-btn increment" onclick="adjustCustomQty(${customItemCounter}, 1)" disabled>+1</button>
                                            </div>
                                            <span class="item-price">-</span>
                                        `;
                                        list.appendChild(newRow);
                                        customItemCounter++;
                                    }
                                } catch (e) {
                                    console.error('Erreur lors de la cr√©ation de ligne personnalis√©e:', e);
                                    return;
                                }
                                existingRows = list.querySelectorAll('.item');
                            }
                            
                            const row = existingRows[index];
                            if (row) {
                                const descInput = row.querySelector('.custom-desc-input');
                                const checkbox = row.querySelector('input[type="checkbox"]');
                                const qtyInput = row.querySelector('.item-qty');
                                
                                if (descInput && checkbox && qtyInput) {
                                    // Remplir la description
                                    descInput.value = customItem.name;
                                    console.log(`Description d√©finie: ${customItem.name}`);
                                    
                                    // Activer la checkbox
                                    checkbox.checked = true;
                                    
                                    // D√©clencher l'√©v√©nement pour activer l'item
                                    const event = new Event('change');
                                    checkbox.dispatchEvent(event);
                                    
                                    // D√©finir la quantit√©
                                    setTimeout(() => {
                                        qtyInput.value = customItem.qty;
                                        console.log(`Quantit√© d√©finie: ${customItem.qty}`);
                                    }, 10);
                                }
                            }
                        });
                        
                        // Mettre √† jour le r√©sum√© apr√®s un d√©lai
                        setTimeout(() => {
                            updateSummary();
                        }, 100);
                        
                    }, 100); // D√©lai pour laisser le temps aux articles standards de se charger
                } else {
                    console.log('Aucun article hors liste √† restaurer');
                }
                
                // 5. Mettre √† jour le r√©sum√© apr√®s tous les d√©lais
                setTimeout(() => {
                    updateSummary();
                    console.log('R√©sum√© mis √† jour');
                }, 200);
                
                // 6. Fermer la modal d'historique
                closeHistory();
                
                // 7. Pas de notification (restauration silencieuse)
                // showNotice('success', `Requ√™te restaur√©e avec succ√®s: ${entry.itemsCount} article${entry.itemsCount > 1 ? 's' : ''} pour ${entry.client}.`);
                
                // 8. Scroll vers le haut pour voir les changements
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
                
            } catch (e) {
                console.error('Erreur lors de la restauration:', e);
                showNotice('error', 'Erreur lors de la restauration de la requ√™te.');
            }
        }

        // Fermer la modal en cliquant √† l'ext√©rieur
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('history-modal');
            if (e.target === modal) {
                closeHistory();
            }
        });

        // Initialiser la navigation au clavier apr√®s la g√©n√©ration des cat√©gories
        document.addEventListener('DOMContentLoaded', function() {
            generateAllCategories();
            initKeyboardNavigation();
            initSearch();
            initCustomItems();
            
            // Initialiser les gestionnaires d'√©v√©nements pour le champ commentaires
            const commentairesField = document.getElementById('commentaires');
            if (commentairesField) {
                commentairesField.addEventListener('focus', function() {
                    isInCommentsField = true;
                });
                commentairesField.addEventListener('blur', function() {
                    isInCommentsField = false;
                });
                
                // D√©sactiver aussi la propagation des √©v√©nements clavier dans le champ commentaires
                commentairesField.addEventListener('keydown', function(e) {
                    e.stopPropagation();
                });
                commentairesField.addEventListener('keyup', function(e) {
                    e.stopPropagation();
                });
                commentairesField.addEventListener('keypress', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Retirer l'√©tat d'erreur quand les champs requis sont renseign√©s
            ['nomIntervenant','client'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => {
                    const valOk = (el.value || '').trim().length > 0;
                    el.classList.toggle('input-error', !valOk);
                    const otherId = id === 'nomIntervenant' ? 'client' : 'nomIntervenant';
                    const otherOk = (document.getElementById(otherId).value || '').trim().length > 0;
                    if (valOk && otherOk) hideFormError();
                });
            });
        });
    </script>
</body>
</html>
